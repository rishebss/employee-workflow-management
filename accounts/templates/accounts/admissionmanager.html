<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admission Dashboard - LP CRM</title>
  <!-- Basecoat CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/basecoat-css@0.2.8/dist/basecoat.cdn.min.css">
  <script src="https://cdn.jsdelivr.net/npm/basecoat-css@0.2.8/dist/js/all.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha512-DxV+EoADOkOygM4IR9yXP8Sb2qwgidEmeqAEmDKIOfPRQZOWbXCzLC6vjbZyy0vPisbH2SyW27+ddLVCN+OMzQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    :root {
      --bg-primary: #000000;
      --bg-secondary: #0a0a0a;
      --card-bg: #111111;
      --border-color: #1f1f1f;
      --border-hover: #333333;
      --text-primary: #ffffff;
      --text-secondary: #a1a1aa;
      --text-tertiary: #71717a;
      --accent: #ffffff;
      --accent-hover: #f4f4f5;
      --shadow-small: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-medium: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-large: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    * {
      margin: 0; padding: 0; box-sizing: border-box;
    }
    body {
      background: var(--bg-primary);
      background-image: 
        radial-gradient(circle at 25% 25%, #1f1f1f 0%, transparent 50%),
        radial-gradient(circle at 75% 75%, #1a1a1a 0%, transparent 50%);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      min-height: 100vh; line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }
    .dashboard-header {
      margin-bottom: 3rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .dashboard-title {
      font-size: clamp(2rem, 4vw, 2.5rem);
      font-weight: 700;
      letter-spacing: -0.025em;
      background: linear-gradient(135deg, #989595 0%, #45454a 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .dashboard-stats {
      display: flex;
      gap: 2rem;
      align-items: center;
    }
    .stat-item {
      text-align: center;
    }
    .stat-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
    }
    .stat-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 0.25rem;
    }
    .header-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .stats-dropdown {
      position: relative;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .add-leads-btn{
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-color: var(--border-color);
    }
    .stats-btn {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-color: var(--border-color);
    }
    .stats-btn:hover {
      background: var(--border-hover);
      border-color: var(--border-hover);
    }
    .stats-dropdown-content {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 1rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: var(--shadow-large);
      z-index: 1000;
      width: 350px;
      padding: 1rem;
      display: none;
      backdrop-filter: blur(60px);
      background: rgba(17, 17, 17, 0.95);
      filter: none !important;
    }
    .stats-dropdown-content.active {
      display: block;
    }
    .stats-section {
      margin-bottom: 1.5rem;
    }
    .stats-section:last-child {
      margin-bottom: 0;
    }
    .stats-section h4 {
      color: var(--text-primary);
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 0.5rem;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
    }
    .stat-item {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 0.6rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s ease;
    }
    .stat-item:hover {
      border-color: var(--border-hover);
      background: rgba(255, 255, 255, 0.02);
    }
    .stat-item .label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-weight: 500;
    }
    .stat-item .value {
      font-size: 1rem;
      font-weight: 600;
      color: var(--accent);
    }
    .search-container {
      display: flex;
      align-items: center;
    }
    .search-box {
      position: relative;
      display: flex;
      align-items: center;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 0.5rem;
      transition: border 0.18s;
      min-width: 350px;
      margin-left: 50px;
    }
    .search-box:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
    }
    .search-icon {
      color: var(--text-secondary);
      margin-right: 0.5rem;
      font-size: 0.9rem;
    }
    .search-input {
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-size: 0.9rem;
      flex: 1;
      outline: none;
    }
    .search-input::placeholder {
      color: var(--text-tertiary);
    }
    .clear-search {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 4px;
      transition: color 0.18s;
    }
    .clear-search:hover {
      color: var(--text-primary);
    }
    .table-row {
      transition: opacity 0.3s ease;
    }
    .table-row.hidden {
      display: none;
    }
    .no-results {
      text-align: center;
      padding: 2rem;
      color: var(--text-secondary);
      font-style: italic;
    }
    /* Blur effect for background when dropdown is active */
    .table-container.blurred {
      filter: blur(10px);
      transition: filter 0.3s ease;
    }
    .table-container {
      overflow-x: auto;
      border-radius: 12px;
      position: relative;
    }
    table.bc-table {
      background: var(--card-bg);
      color: var(--text-primary);
      border-radius: 14px;
      border: none;
      box-shadow: 0 4px 32px 0 rgba(0,0,0,0.18);
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    .bc-table th, .bc-table td {
      background: transparent;
      color: var(--text-primary);
      border: none;
      font-size: 1rem;
      padding: 1.05rem 0.9rem;
      vertical-align: middle;
      transition: background 0.18s;
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* Serial number column styling */
    .bc-table th:first-child {
      width: 60px;
      text-align: center;
      font-weight: 600;
      color: var(--text-secondary);
    }
    .bc-table td:first-child {
      width: 60px;
      text-align: center;
      font-weight: 600;
      color: var(--text-secondary);
      background: rgba(255, 255, 255, 0.02);
    }
    .bc-table th {
      background: var(--bg-secondary);
      color: var(--text-secondary);
      font-weight: 600;
      letter-spacing: 0.04em;
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .bc-table-striped tbody tr:nth-child(odd) {
      background: rgba(255,255,255,0.01);
    }
    .bc-table tbody tr {
      border-bottom: 1px solid var(--border-color);
      transition: background 0.18s, box-shadow 0.18s;
    }
    .bc-table tbody tr:last-child {
      border-bottom: none;
    }
    .bc-table tbody tr:hover {
      background: rgba(255,255,255,0.03);
      box-shadow: 0 2px 8px 0 rgba(0,0,0,0.10);
      cursor: pointer;
    }
    .bc-table td {
      border-top: none;
      border-bottom: none;
    }
    /* Column width definitions */
    .bc-table th:nth-child(1), .bc-table td:nth-child(1) { width: 60px; } /* Serial Number */
    .bc-table th:nth-child(2), .bc-table td:nth-child(2) { width: 16%; } /* Name */
    .bc-table th:nth-child(3), .bc-table td:nth-child(3) { width: 16%; } /* Phone */
    .bc-table th:nth-child(4), .bc-table td:nth-child(4) { width: 16%; } /* Remarks */
    .bc-table th:nth-child(5), .bc-table td:nth-child(5) { width: 10%; } /* Source */
    .bc-table th:nth-child(6), .bc-table td:nth-child(6) { width: 12%; } /* Status */
    .bc-table th:nth-child(7), .bc-table td:nth-child(7) { width: 12%; } /* Program */
    .bc-table th:nth-child(8), .bc-table td:nth-child(8) { width: 13%; } /* Priority */
    .bc-table th:nth-child(9), .bc-table td:nth-child(9) { width: 14%; } /* Assign */
    
    .priority-select, .program-select {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 0.35rem 1.5rem 0.35rem 0.7rem;
      font-size: 1rem;
      appearance: none;
      cursor: pointer;
      transition: border 0.18s, background 0.18s;
      width: 100%;
    }
    .priority-select:focus, .program-select:focus {
      outline: 2px solid var(--accent);
      border-color: var(--accent);
      background: var(--card-bg);
    }
    
    /* Status input field styling */
    .status-input {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 0.35rem 0.7rem;
      font-size: 1rem;
      width: 100%;
      transition: border 0.18s, background 0.18s;
    }
    .status-input:focus {
      outline: 2px solid var(--accent);
      border-color: var(--accent);
      background: var(--card-bg);
    }
    
    .btn {
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 500;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
      margin-right: 0.2rem;
    }
    .btn-contact {
      background: var(--accent);
      color: var(--bg-primary);
    }
    .btn-contact:hover, .btn-contact:active {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }
    .btn-notes {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
    }
    .btn-notes:hover, .btn-notes:active {
      color: var(--text-primary);
      border-color: var(--border-hover);
      background: rgba(255, 255, 255, 0.02);
    }
    .table-scroll-vert {
      max-height: 70vh;
      overflow-y: auto;
      overflow-x: hidden;
      position: relative;
      width: 100%;
      /* Add padding to prevent scrollbar from interfering with table rounded corners */
      padding-right: 8px;
      /* Custom scrollbar styling for cleaner appearance */
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
    }

    /* Webkit scrollbar styling for Chrome/Safari */
    .table-scroll-vert::-webkit-scrollbar {
      width: 6px;
    }

    .table-scroll-vert::-webkit-scrollbar-track {
      background: transparent;
      border-radius: 3px;
    }

    .table-scroll-vert::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
    }

    .table-scroll-vert::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    @media (max-width: 1200px) {
      .dashboard-container { padding:1rem }
      .dashboard-header { flex-direction: column; align-items: flex-start }
      .header-controls { flex-direction: column; align-items: stretch; gap: 0.5rem; }
      .dashboard-stats { gap:1rem }
      .bc-table th, .bc-table td { padding: 0.75rem 0.5rem; font-size: 0.9rem; }
      .search-box { min-width: 250px; }
      .stats-dropdown-content { width: 300px; }
    }
    @media (max-width: 768px) {
      .dashboard-container { padding:0.5rem }
      .dashboard-header { gap: 0.6rem }
      .bc-table th, .bc-table td { padding: 0.5rem 0.3rem; font-size: 0.8rem; }
      .table-scroll-vert { max-height: 60vh; }
      .search-box { min-width: 200px; padding: 0.4rem; }
      .search-input { font-size: 0.8rem; }
      .stats-dropdown-content { width: 280px; padding: 1rem; }
      .stats-grid { grid-template-columns: 1fr; }
    }

    .assign-select {
  background: var(--bg-secondary);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 0.35rem 1.5rem 0.35rem 0.7rem;
  font-size: 1rem;
  appearance: none;
  cursor: pointer;
  transition: border 0.18s, background 0.18s;
  width: 100%;
}

.assign-select:focus {
  outline: 2px solid var(--accent);
  border-color: var(--accent);
  background: var(--card-bg);
}
.remarks-input {
  background: var(--bg-secondary);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 0.5rem;
  font-size: 0.9rem;
  width: 100%;
  transition: border 0.2s;
}

.remarks-input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
}

/* Modal Styles */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(10px);
}

.modal-content {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 16px;
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: var(--shadow-large);
  display: flex;
  flex-direction: column;
  /* Custom scrollbar styling for cleaner appearance */
  scrollbar-width: thin;
  scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
}

/* Webkit scrollbar styling for Chrome/Safari */
.modal-content::-webkit-scrollbar {
  width: 6px;
}

.modal-content::-webkit-scrollbar-track {
  background: transparent;
}

.modal-content::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 3px;
}

.modal-content::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1.5rem;
  border-bottom: 1px solid var(--border-color);
}

.modal-title {
  color: var(--text-primary);
  font-size: 1.5rem;
  font-weight: 600;
  margin: 0;
}

.modal-close {
  background: transparent;
  border: none;
  color: var(--text-secondary);
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0.5rem;
  border-radius: 8px;
  transition: all 0.2s ease;
}

.modal-close:hover {
  color: var(--text-primary);
  background: rgba(255, 255, 255, 0.1);
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1rem;
  padding: 1.5rem;
}

.form-field {
  display: flex;
  flex-direction: column;
}

.form-field:nth-child(9) {
  grid-column: 1 / -1;
}

.form-field label {
  color: var(--text-primary);
  font-size: 0.9rem;
  font-weight: 500;
  margin-bottom: 0.5rem;
}

.form-input, .form-select, .form-textarea {
  background: var(--bg-secondary);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 0.75rem;
  font-size: 0.9rem;
  transition: border 0.2s ease;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
}

.form-textarea {
  resize: vertical;
  min-height: 80px;
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 1rem;
  padding: 1.5rem;
  border-top: 1px solid var(--border-color);
  flex-shrink: 0;
}

@media (max-width: 768px) {
  .form-grid {
    grid-template-columns: 1fr;
    padding: 1rem;
  }
  
  .modal-content {
    width: 95%;
    margin: 1rem;
  }
  
  .modal-header, .modal-footer {
    padding: 1rem;
  }
    }

    /* Tab Styles for Import Modal */
.active-tab {
  background: var(--accent) !important;
  color: var(--bg-primary) !important;
  border-color: var(--accent) !important;
}

    .add-leads-btn.active-tab:hover {
      background: var(--accent-hover) !important;
      color: var(--bg-primary) !important;
    }

    /* Task Sidebar Styles */
    .task-sidebar {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100vh;
      background: var(--card-bg);
      border-left: 1px solid var(--border-color);
      z-index: 10000;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.3);
    }

    .task-sidebar.active {
      right: 0;
    }

    .task-sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-secondary);
    }

    .task-sidebar-header h3 {
      margin: 0;
      color: var(--text-primary);
      font-size: 1.25rem;
      font-weight: 600;
    }

    .task-close-btn {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 1.25rem;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .task-close-btn:hover {
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.1);
    }

    .task-sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .task-filters {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .task-filter {
      flex: 1;
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 0.5rem;
      font-size: 0.85rem;
    }

    .task-filter:focus {
      outline: none;
      border-color: var(--accent);
    }

    .task-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .task-item {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem;
      transition: all 0.2s ease;
    }

    .task-item:hover {
      border-color: var(--border-hover);
      background: rgba(255, 255, 255, 0.02);
    }

    .task-item.overdue {
      border-color: #ef4444;
      background: rgba(239, 68, 68, 0.05);
    }

    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.75rem;
    }

    .task-title {
      margin: 0;
      color: var(--text-primary);
      font-size: 1rem;
      font-weight: 600;
      line-height: 1.3;
    }

    .task-badges {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .task-priority, .task-status {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .task-priority.low {
      background: rgba(107, 114, 128, 0.2);
      color: #9ca3af;
    }

    .task-priority.medium {
      background: rgba(245, 158, 11, 0.2);
      color: #fcd34d;
    }

    .task-priority.high {
      background: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
    }

    .task-priority.urgent {
      background: rgba(139, 69, 19, 0.2);
      color: #fbbf24;
    }

    .task-status.pending {
      background: rgba(107, 114, 128, 0.2);
      color: #9ca3af;
    }

    .task-status.in-progress {
      background: rgba(59, 130, 246, 0.2);
      color: #93c5fd;
    }

    .task-status.completed {
      background: rgba(34, 197, 94, 0.2);
      color: #86efac;
    }

    .task-status.overdue {
      background: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
    }

    .task-description {
      color: var(--text-secondary);
      font-size: 0.9rem;
      line-height: 1.4;
      margin-bottom: 0.75rem;
    }

    .task-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    .task-deadline {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .overdue-text {
      color: #ef4444;
      font-weight: 600;
    }

    .task-status-select {
      background: var(--bg-primary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 0.25rem 0.5rem;
      font-size: 0.8rem;
    }

    .task-empty, .task-error {
      text-align: center;
      color: var(--text-secondary);
      padding: 2rem;
      font-style: italic;
    }

    .task-error {
      color: #ef4444;
    }

    .task-count {
      background: var(--accent);
      color: var(--bg-primary);
      border-radius: 50%;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }

    @media (max-width: 768px) {
      .task-sidebar {
        width: 100%;
        right: -100%;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <div class="dashboard-header">
      <h1 class="dashboard-title">AM DASHBOARD</h1>
      <div class="header-controls">
        <div class="stats-dropdown">
          <button class="add-leads-btn" ><a href="{% url 'accounts:all_leads' %}"  style="margin-left: 0.5rem;">
            <i class="fa-solid fa-eye"></i>
            <span>View Leads</span>
          </a></button>
          <button class="add-leads-btn" ><a href="{% url 'accounts:staff_reports' %}"  style="margin-left: 0.5rem;">
            <i class="fa-solid fa-file-lines"></i>
            <span>Reports</span>
          </a></button>
          <button class="add-leads-btn" id="addLeadBtn" style="margin-left: 0.5rem;">
            <i class="fas fa-plus"></i>
            <span>Add Lead</span>
          </button>
          <button class="add-leads-btn" id="importExcelBtn" style="margin-left: 0.5rem;">
            <i class="fas fa-file-excel"></i>
            <span>Import Excel</span>
          </button>

          <button class="add-leads-btn" id="tasksBtn" style="margin-left: 0.5rem;">
            <i class="fas fa-tasks"></i>
            <span>My Tasks</span>
            <span id="taskCount" class="task-count" style="display: none;">0</span>
          </button>
          <button class="stats-btn" id="statsBtn">
            <i class="fas fa-chart-bar"></i>
            <span>Stats</span>
            <i class="fas fa-chevron-down"></i>
          </button>
          <div class="stats-dropdown-content" id="statsDropdown">
            <div class="stats-section">
             
              <div class="stats-grid" id="programStats">
                <!-- Will be populated by JavaScript -->
              </div>
            </div>
            <div class="stats-section">
              
              <div class="stats-grid" id="priorityStats">
                <!-- Will be populated by JavaScript -->
              </div>
            </div>
            <div class="stats-section">
             
              <div class="stats-grid" id="statusStats">
                <!-- Will be populated by JavaScript -->
              </div>
            </div>
          </div>
        </div>
        <div class="search-container">
          <div class="search-box">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="searchInput" placeholder=" Search..." class="search-input">
            <button id="clearSearch" class="clear-search" style="display: none;">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
      </div>
    </div>


    <div class="table-container">
      <div class="table-scroll-vert">
        <table class="bc-table bc-table-striped">
          <thead>
            <tr>
              <th style="width: 60px;">#</th>
              <th>Name</th>
              <th>Phone</th>
              <th>Remarks</th>
              <th>Source</th>
              <th>Status</th>
              <th>Program</th>
              <th>Priority</th>
              <th>Assign</th>
            </tr>
          </thead>
          <tbody id="leads-table-body">
            {% for lead in high_priority_leads %}
              <tr class="table-row" data-priority="high" data-lead-id="{{ lead.id }}"
                  data-name="{{ lead.name|lower }}"
                  data-phone="{{ lead.phone|lower }}"
                  data-program="{{ lead.program|lower|default:'' }}"
                  data-status="{{ lead.status|lower }}"
                  data-priority="{{ lead.get_priority_display|lower }}">
                <td style="text-align: center; font-weight: 600; color: var(--text-secondary);">{{ forloop.counter }}</td>
                <td><a href="{% url 'accounts:lead_details' lead.id %}" style="color: var(--accent); text-decoration: none; font-weight: 500;">{{ lead.name }}</a></td>
                <td>{{ lead.phone }}</td>
                <td>
  <input type="text" class="remarks-input" 
         data-lead-id="{{ lead.id }}" 
         value="{{ lead.remarks|default:'' }}" 
         placeholder="Add remarks"
         style="width: 100%; 
                background: var(--bg-secondary); 
                color: var(--text-primary); 
                border: 1px solid var(--border-color); 
                border-radius: 8px; 
                padding: 0.35rem 0.7rem; 
                font-size: 1rem;" />
</td>
                <td>{{ lead.get_source_display }}</td>
                <td>
                  <!-- Changed from select to input for status -->
                  <input type="text" class="status-input" 
                         data-lead-id="{{ lead.id }}" 
                         value="{{ lead.status }}" 
                         placeholder="Enter status"
                         list="status-suggestions"
                         style="width: 100%; 
                                background: var(--bg-secondary); 
                                color: var(--text-primary); 
                                border: 1px solid var(--border-color); 
                                border-radius: 8px; 
                                padding: 0.35rem 0.7rem; 
                                font-size: 1rem;" />
                </td>
                <td>
                  <input type="text" class="program-input" data-lead-id="{{ lead.id }}" value="{{ lead.program|default:'' }}" placeholder="Enter program name" style="width: 100%; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.35rem 0.7rem; font-size: 1rem;" />
                </td>
                <td>
                  <select class="priority-select" data-lead-id="{{ lead.id }}">
                    <option value="HIGH" {% if lead.priority == 'HIGH' %}selected{% endif %}>High üî•</option>
                    <option value="MEDIUM" {% if lead.priority == 'MEDIUM' %}selected{% endif %}>Medium ‚ö†Ô∏è</option>
                    <option value="LOW" {% if lead.priority == 'LOW' %}selected{% endif %}>Low üê¢</option>
                  </select>
                </td>
                <td>
  <select class="assign-select" data-lead-id="{{ lead.id }}">
    <option value="">Unassigned</option>
    {% for executive in admission_executives %}
      <option value="{{ executive.id }}" 
              {% if lead.assigned_to == executive %}selected{% endif %}>
        {{ executive.get_full_name }} (Executive)
      </option>
    {% endfor %}
  </select>
</td>
              </tr>
            {% endfor %}
            
            {% for lead in medium_priority_leads %}
              <tr class="table-row" data-priority="medium" data-lead-id="{{ lead.id }}"
                  data-name="{{ lead.name|lower }}"
                  data-phone="{{ lead.phone|lower }}"
                  data-program="{{ lead.program|lower|default:'' }}"
                  data-status="{{ lead.status|lower }}"
                  data-priority="{{ lead.get_priority_display|lower }}">
                <td style="text-align: center; font-weight: 600; color: var(--text-secondary);">{{ forloop.counter }}</td>
                <td><a href="{% url 'accounts:lead_details' lead.id %}" style="color: var(--accent); text-decoration: none; font-weight: 500;">{{ lead.name }}</a></td>
                <td>{{ lead.phone }}</td>
                <td>
  <input type="text" class="remarks-input" 
         data-lead-id="{{ lead.id }}" 
         value="{{ lead.remarks|default:'' }}" 
         placeholder="Add remarks"
         style="width: 100%; 
                background: var(--bg-secondary); 
                color: var(--text-primary); 
                border: 1px solid var(--border-color); 
                border-radius: 8px; 
                padding: 0.35rem 0.7rem; 
                font-size: 1rem;" />
</td>
                <td>{{ lead.get_source_display }}</td>
                <td>
                  <!-- Changed from select to input for status -->
                  <input type="text" class="status-input" 
                         data-lead-id="{{ lead.id }}" 
                         value="{{ lead.status }}" 
                         placeholder="Enter status"
                         list="status-suggestions"
                         style="width: 100%; 
                                background: var(--bg-secondary); 
                                color: var(--text-primary); 
                                border: 1px solid var(--border-color); 
                                border-radius: 8px; 
                                padding: 0.35rem 0.7rem; 
                                font-size: 1rem;" />
                </td>
                <td>
                  <input type="text" class="program-input" data-lead-id="{{ lead.id }}" value="{{ lead.program|default:'' }}" placeholder="Enter program name" style="width: 100%; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.35rem 0.7rem; font-size: 1rem;" />
                </td>
                <td>
                  <select class="priority-select" data-lead-id="{{ lead.id }}">
                    <option value="HIGH" {% if lead.priority == 'HIGH' %}selected{% endif %}>High üî•</option>
                    <option value="MEDIUM" {% if lead.priority == 'MEDIUM' %}selected{% endif %}>Medium ‚ö†Ô∏è</option>
                    <option value="LOW" {% if lead.priority == 'LOW' %}selected{% endif %}>Low üê¢</option>
                  </select>
                </td>
                <td>
  <select class="assign-select" data-lead-id="{{ lead.id }}">
    <option value="">Unassigned</option>
    {% for executive in admission_executives %}
      <option value="{{ executive.id }}" 
              {% if lead.assigned_to == executive %}selected{% endif %}>
        {{ executive.get_full_name }} (Executive)
      </option>
    {% endfor %}
  </select>
</td>
              </tr>
            {% endfor %}
            
            {% for lead in low_priority_leads %}
              <tr class="table-row" data-priority="low" data-lead-id="{{ lead.id }}"
                  data-name="{{ lead.name|lower }}"
                  data-phone="{{ lead.phone|lower }}"
                  data-program="{{ lead.program|lower|default:'' }}"
                  data-status="{{ lead.status|lower }}"
                  data-priority="{{ lead.get_priority_display|lower }}">
                <td style="text-align: center; font-weight: 600; color: var(--text-secondary);">{{ forloop.counter }}</td>
                <td><a href="{% url 'accounts:lead_details' lead.id %}" style="color: var(--accent); text-decoration: none; font-weight: 500;">{{ lead.name }}</a></td>
                <td>{{ lead.phone }}</td>
                <td>
  <input type="text" class="remarks-input" 
         data-lead-id="{{ lead.id }}" 
         value="{{ lead.remarks|default:'' }}" 
         placeholder="Add remarks"
         style="width: 100%; 
                background: var(--bg-secondary); 
                color: var(--text-primary); 
                border: 1px solid var(--border-color); 
                border-radius: 8px; 
                padding: 0.35rem 0.7rem; 
                font-size: 1rem;" />
</td>
                <td>{{ lead.get_source_display }}</td>
                <td>
                  <!-- Changed from select to input for status -->
                  <input type="text" class="status-input" 
                         data-lead-id="{{ lead.id }}" 
                         value="{{ lead.status }}" 
                         placeholder="Enter status"
                         list="status-suggestions"
                         style="width: 100%; 
                                background: var(--bg-secondary); 
                                color: var(--text-primary); 
                                border: 1px solid var(--border-color); 
                                border-radius: 8px; 
                                padding: 0.35rem 0.7rem; 
                                font-size: 1rem;" />
                </td>
                <td>
                  <input type="text" class="program-input" data-lead-id="{{ lead.id }}" value="{{ lead.program|default:'' }}" placeholder="Enter program name" style="width: 100%; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.35rem 0.7rem; font-size: 1rem;" />
                </td>
                <td>
                  <select class="priority-select" data-lead-id="{{ lead.id }}">
                    <option value="HIGH" {% if lead.priority == 'HIGH' %}selected{% endif %}>High üî•</option>
                    <option value="MEDIUM" {% if lead.priority == 'MEDIUM' %}selected{% endif %}>Medium ‚ö†Ô∏è</option>
                    <option value="LOW" {% if lead.priority == 'LOW' %}selected{% endif %}>Low üê¢</option>
                  </select>
                </td>
                <td>
  <select class="assign-select" data-lead-id="{{ lead.id }}">
    <option value="">Unassigned</option>
    {% for executive in admission_executives %}
      <option value="{{ executive.id }}" 
              {% if lead.assigned_to == executive %}selected{% endif %}>
        {{ executive.get_full_name }} (Executive)
      </option>
    {% endfor %}
  </select>
</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Status suggestions datalist -->
    <datalist id="status-suggestions">
      <option value="Enquiry">
      <option value="Interested">
      <option value="Not Interested">
      <option value="Walk In">
      <option value="On Hold">
      <option value="Registered">
      <option value="Follow Up">
      <option value="Converted">
      <option value="Lost">
      <option value="Cold">
      <option value="Warm">
      <option value="Hot">
    </datalist>

    <!-- Add Lead Modal -->
    <div id="addLeadModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Add New Lead</h2>
          <button class="modal-close" onclick="closeAddLeadModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="addLeadForm">
          {% csrf_token %}
          <div class="form-grid">
            <div class="form-field">
              <label for="leadName">Name *</label>
              <input type="text" id="leadName" name="name" required class="form-input">
            </div>
            <div class="form-field">
              <label for="leadPhone">Phone *</label>
              <input type="tel" id="leadPhone" name="phone" required class="form-input">
            </div>
            <div class="form-field">
              <label for="leadEmail">Email</label>
              <input type="email" id="leadEmail" name="email" class="form-input">
            </div>
            <div class="form-field">
              <label for="leadPriority">Priority</label>
              <select id="leadPriority" name="priority" class="form-select">
                <option value="HIGH">High üî•</option>
                <option value="MEDIUM" selected>Medium ‚ö†Ô∏è</option>
                <option value="LOW">Low üê¢</option>
              </select>
            </div>
            <div class="form-field">
              <label for="leadStatus">Status</label>
              <input type="text" id="leadStatus" name="status" class="form-input" 
                     placeholder="Enter status" value="ENQUIRY" list="status-suggestions">
            </div>
            <div class="form-field">
              <label for="leadProgram">Program</label>
              <input type="text" id="leadProgram" name="program" class="form-input" placeholder="Enter program name">
            </div>
            <div class="form-field">
              <label for="leadSource">Source</label>
              <select id="leadSource" name="source" class="form-select">
                <option value="WHATSAPP">WhatsApp</option>
                <option value="INSTAGRAM">Instagram</option>
                <option value="WEBSITE">Website</option>
                <option value="WALK_IN">Walk-in</option>
                <option value="AUTOMATION">Automation</option>
                <option value="OTHER">Other</option>
              </select>
            </div>
            <div class="form-field">
              <label for="leadLocation">Location</label>
              <input type="text" id="leadLocation" name="location" class="form-input" placeholder="Enter location">
            </div>
            <div class="form-field">
              <label for="leadRemarks">Remarks</label>
              <textarea id="leadRemarks" name="remarks" class="form-textarea" placeholder="Additional notes"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-notes" onclick="closeAddLeadModal()">Cancel</button>
            <button type="submit" class="btn btn-contact">Add Lead</button>
          </div>
        </form>
      </div>
    </div>
      <!-- Import Excel Modal -->
<div id="importExcelModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Import Leads from Excel</h2>
      <button class="modal-close" onclick="closeImportModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form id="importExcelForm" enctype="multipart/form-data" style="display: flex; flex-direction: column; flex: 1;">
      {% csrf_token %}
      <div style="padding: 1.5rem; flex: 1; overflow-y: auto; min-height: 0;">
        <div class="form-field" style="margin-bottom: 1rem;">
          <div style="display: inline-flex; gap: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border-color); padding: 0.25rem; border-radius: 0.5rem;">
            <button type="button" id="tabUpload" class="add-leads-btn" style="padding: 0.35rem 0.75rem;">Upload Excel</button>
            <button type="button" id="tabPaste" class="add-leads-btn" style="padding: 0.35rem 0.75rem;">Paste Rows</button>
          </div>
        </div>
        <div class="form-field" id="uploadSection">
          <label for="excel_file">Select Excel File</label>
          <input 
            type="file" 
            id="excel_file" 
            name="excel_file" 
            accept=".xlsx, .xls" 
            class="form-input"
            required
          >
          <div class="field-info" style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.5rem;">
            <p>‚úÖ Supported formats: .xlsx, .xls</p>
            <p>üìù Leads will be automatically assigned to you</p>
            <p>üì• Download <a href="{% url 'accounts:download_excel_template' %}" style="color: var(--accent); text-decoration: underline;">Excel template</a> for reference</p>
          </div>
        </div>
        <div class="form-field" id="pasteSection" style="display: none;">
          <label for="pasted_rows">Paste table rows (CSV/TSV)</label>
          <textarea id="pasted_rows" name="pasted_rows" class="form-textarea" placeholder="Paste rows with headers here (CSV or tab-separated)"></textarea>
          <div class="field-info" style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.5rem;">
            <p>üß© Required columns: name, phone (case-insensitive). Optional: email, location, program, priority, status, source, remarks</p>
            <p>üí° Column names are flexible: "Name", "Phone/Mobile/Contact", "Email", "Location/Address", "Program/Course", "Priority", "Status", "Source", "Remarks/Notes/Comments"</p>
            <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
              <button type="button" id="previewPasteBtn" class="add-leads-btn">Preview Pasted Rows</button>
              <button type="button" id="clearPasteBtn" class="add-leads-btn">Clear</button>
            </div>
          </div>
        </div>
        
        <!-- Preview Section -->
        <div id="previewSection" style="display: none; margin-top: 1rem; margin-bottom: 1rem;">
          <h3 style="font-size: 1rem; margin-bottom: 0.5rem; color: var(--text-secondary);">Preview (First 5 rows)</h3>
          <div id="previewTable" class="table-wrapper" style="max-height: 200px; font-size: 0.75rem; background: var(--bg-secondary); border-radius: 8px; padding: 0.5rem; overflow-y: auto;">
            <!-- Preview will be loaded here -->
          </div>
          <div id="previewStats" style="margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.75rem;">
            <!-- Stats will be loaded here -->
          </div>
        </div>
        
        <!-- Import Progress -->
        <div id="importProgress" style="display: none; margin-top: 1rem; margin-bottom: 1rem;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <span style="color: var(--text-secondary);">Importing...</span>
            <span id="progressText" style="color: var(--accent); font-weight: 600;">0%</span>
          </div>
          <div style="background: var(--bg-secondary); border-radius: 4px; height: 8px;">
            <div id="progressBar" style="background: var(--accent); height: 100%; width: 0%; border-radius: 4px; transition: width 0.3s;"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-notes" onclick="closeImportModal()">Cancel</button>
        <button type="submit" class="btn btn-contact" id="importButton">
          <i class="fas fa-upload mr-1"></i> Import Leads
        </button>
      </div>
    </form>
      </div>
    </div>
    <script>
// Import Modal functionality
const importExcelBtn = document.getElementById('importExcelBtn');
const importExcelModal = document.getElementById('importExcelModal');

// Open import modal
if (importExcelBtn) {
  importExcelBtn.addEventListener('click', function() {
    console.log('Import button clicked');
    importExcelModal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    resetImportForm();
  });
}

// Close import modal
function closeImportModal() {
  console.log('Closing import modal');
  importExcelModal.style.display = 'none';
  document.body.style.overflow = 'auto';
  resetImportForm();
}

function resetImportForm() {
  const excelFileInput = document.getElementById('excel_file');
  const pastedTextarea = document.getElementById('pasted_rows');
  const previewSection = document.getElementById('previewSection');
  const importProgress = document.getElementById('importProgress');
  const importButton = document.getElementById('importButton');
  
  if (excelFileInput) excelFileInput.value = '';
  if (pastedTextarea) pastedTextarea.value = '';
  if (previewSection) previewSection.style.display = 'none';
  if (importProgress) importProgress.style.display = 'none';
  if (importButton) {
    importButton.disabled = false;
    importButton.innerHTML = '<i class="fas fa-upload mr-1"></i> Import Leads';
  }
  
  // Reset to upload tab
  activateUploadTab();
}

// Tab management
function activateUploadTab() {
  console.log('Activating upload tab');
  const tabUpload = document.getElementById('tabUpload');
  const tabPaste = document.getElementById('tabPaste');
  const uploadSection = document.getElementById('uploadSection');
  const pasteSection = document.getElementById('pasteSection');
  const fileInput = document.getElementById('excel_file');
  
  if (tabUpload) tabUpload.classList.add('active-tab');
  if (tabPaste) tabPaste.classList.remove('active-tab');
  if (uploadSection) uploadSection.style.display = 'block';
  if (pasteSection) pasteSection.style.display = 'none';
  
  // Update form requirements
  if (fileInput) fileInput.required = true;
}

function activatePasteTab() {
  console.log('Activating paste tab');
  const tabUpload = document.getElementById('tabUpload');
  const tabPaste = document.getElementById('tabPaste');
  const uploadSection = document.getElementById('uploadSection');
  const pasteSection = document.getElementById('pasteSection');
  const fileInput = document.getElementById('excel_file');
  
  if (tabPaste) tabPaste.classList.add('active-tab');
  if (tabUpload) tabUpload.classList.remove('active-tab');
  if (uploadSection) uploadSection.style.display = 'none';
  if (pasteSection) pasteSection.style.display = 'block';
  
  // Update form requirements
  if (fileInput) fileInput.required = false;
}

// Initialize import functionality when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded - initializing import functionality');
  
  const tabUpload = document.getElementById('tabUpload');
  const tabPaste = document.getElementById('tabPaste');
  const pastedTextarea = document.getElementById('pasted_rows');
  const previewPasteBtn = document.getElementById('previewPasteBtn');
  const clearPasteBtn = document.getElementById('clearPasteBtn');
  const importForm = document.getElementById('importExcelForm');
  
  // Initialize tabs
  if (tabUpload && tabPaste) {
    tabUpload.addEventListener('click', activateUploadTab);
    tabPaste.addEventListener('click', activatePasteTab);
    activateUploadTab(); // Start with upload tab active
  }

  // Preview paste data
  if (previewPasteBtn) {
    previewPasteBtn.addEventListener('click', function() {
      console.log('Preview paste button clicked');
      const pastedData = pastedTextarea ? pastedTextarea.value : '';
      if (!pastedData.trim()) {
        showToast('Please paste some data first', 'error');
        return;
      }
      previewPastedData(pastedData);
    });
  }

  // Clear paste data
  if (clearPasteBtn) {
    clearPasteBtn.addEventListener('click', function() {
      console.log('Clear paste button clicked');
      if (pastedTextarea) pastedTextarea.value = '';
      const previewSection = document.getElementById('previewSection');
      if (previewSection) previewSection.style.display = 'none';
    });
  }

  // Handle file selection for preview
  const excelFileInput = document.getElementById('excel_file');
  if (excelFileInput) {
    excelFileInput.addEventListener('change', function(e) {
      console.log('File selected:', this.files[0]?.name);
      if (this.files.length > 0) {
        previewExcelFile(this.files[0]);
      }
    });
  }
  
  // Handle import form submission
  if (importForm) {
    importForm.addEventListener('submit', function(e) {
      console.log('Import form submitted');
      handleExcelImport(e);
    });
  }

  // Close modal when clicking outside
  if (importExcelModal) {
    importExcelModal.addEventListener('click', function(e) {
      if (e.target === importExcelModal) {
        closeImportModal();
      }
    });
  }

  // Close modal with escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && importExcelModal.style.display === 'flex') {
      closeImportModal();
    }
  });
});

// Preview Excel file
function previewExcelFile(file) {
  console.log('Previewing Excel file:', file.name);
  const previewSection = document.getElementById('previewSection');
  const previewTable = document.getElementById('previewTable');
  const previewStats = document.getElementById('previewStats');
  
  if (!previewSection || !previewTable) {
    console.error('Preview elements not found');
    return;
  }
  
  previewSection.style.display = 'block';
  previewTable.innerHTML = '<div style="text-align: center; padding: 1rem; color: var(--text-secondary);">Loading preview...</div>';
  if (previewStats) previewStats.innerHTML = '';
  
  const formData = new FormData();
  formData.append('excel_file', file);
  formData.append('preview_only', 'true');
  
  fetch("{% url 'accounts:import_leads_excel' %}", {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: formData
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    console.log('Preview response:', data);
    if (data.status === 'success') {
      displayPreview(data.preview_data, data.stats);
    } else {
      previewTable.innerHTML = `<div style="color: #ef4444; text-align: center; padding: 1rem;">Error: ${data.message}</div>`;
    }
  })
  .catch(error => {
    console.error('Error loading preview:', error);
    previewTable.innerHTML = `<div style="color: #ef4444; text-align: center; padding: 1rem;">Error loading preview: ${error.message}</div>`;
  });
}

// Preview pasted data
function previewPastedData(text) {
  console.log('Previewing pasted data:', text.substring(0, 100) + '...');
  const previewSection = document.getElementById('previewSection');
  const previewTable = document.getElementById('previewTable');
  const previewStats = document.getElementById('previewStats');

  if (!text || !text.trim()) {
    showToast('Please paste some rows first', 'error');
    return;
  }

  if (!previewSection || !previewTable) {
    console.error('Preview elements not found');
    return;
  }

  previewSection.style.display = 'block';
  previewTable.innerHTML = '<div style="text-align: center; padding: 1rem; color: var(--text-secondary);">Parsing preview...</div>';
  if (previewStats) previewStats.innerHTML = '';

  const formData = new FormData();
  formData.append('pasted_data', text);
  formData.append('preview_only', 'true');

  fetch("{% url 'accounts:import_leads_excel' %}", {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: formData
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    console.log('Paste preview response:', data);
    if (data.status === 'success') {
      displayPreview(data.preview_data, data.stats);
    } else {
      previewTable.innerHTML = `<div style="color: #ef4444; text-align: center; padding: 1rem;">Error: ${data.message}</div>`;
    }
  })
  .catch(error => {
    console.error('Error loading paste preview:', error);
    previewTable.innerHTML = `<div style="color: #ef4444; text-align: center; padding: 1rem;">Error loading preview: ${error.message}</div>`;
  });
}

// Display preview data
function displayPreview(previewData, stats) {
  console.log('Displaying preview data');
  const previewTable = document.getElementById('previewTable');
  const previewStats = document.getElementById('previewStats');
  
  if (!previewTable) {
    console.error('Preview table element not found');
    return;
  }
  
  let tableHTML = `
    <table style="width: 100%; border-collapse: collapse; font-size: 0.7rem;">
      <thead>
        <tr style="background: var(--bg-secondary);">
          ${previewData.headers.map(header => `<th style="padding: 0.5rem; border: 1px solid var(--border-color); text-align: left;">${header}</th>`).join('')}
        </tr>
      </thead>
      <tbody>
        ${previewData.rows.map(row => `
          <tr>
            ${row.map(cell => `<td style="padding: 0.5rem; border: 1px solid var(--border-color);">${cell || ''}</td>`).join('')}
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
  
  previewTable.innerHTML = tableHTML;
  
  if (previewStats) {
    let statsHTML = `
      <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <div><strong>Total rows:</strong> ${stats.total_rows}</div>
        <div style="color: #22c55e;"><strong>Valid rows:</strong> ${stats.valid_rows}</div>
        ${stats.invalid_rows > 0 ? `<div style="color: #f59e0b;"><strong>Invalid rows:</strong> ${stats.invalid_rows}</div>` : ''}
      </div>
    `;
    previewStats.innerHTML = statsHTML;
  }
}

// Handle Excel import
async function handleExcelImport(e) {
  e.preventDefault();
  console.log('Handling Excel import');
  
  const fileInput = document.getElementById('excel_file');
  const importButton = document.getElementById('importButton');
  const importProgress = document.getElementById('importProgress');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  const pastedTextarea = document.getElementById('pasted_rows');
  
  const hasFile = fileInput && fileInput.files && fileInput.files.length > 0;
  const hasPasted = pastedTextarea && pastedTextarea.value.trim().length > 0;

  console.log('Has file:', hasFile, 'Has pasted:', hasPasted);

  if (!hasFile && !hasPasted) {
    showToast('Please select a file or paste rows to import', 'error');
    return;
  }
  
  const formData = new FormData();
  
  if (hasFile) {
    formData.append('excel_file', fileInput.files[0]);
    console.log('Using file:', fileInput.files[0].name);
  } else if (hasPasted) {
    formData.append('pasted_data', pastedTextarea.value);
    console.log('Using pasted data, length:', pastedTextarea.value.length);
  }
  
  if (!importButton || !importProgress || !progressBar || !progressText) {
    console.error('Import progress elements not found');
    showToast('Import system error - please refresh the page', 'error');
    return;
  }
  
  importButton.disabled = true;
  importButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Importing...';
  importProgress.style.display = 'block';
  
  // Simulate progress
  let progress = 0;
  const progressInterval = setInterval(() => {
    progress += 5;
    if (progress <= 90) {
      progressBar.style.width = `${progress}%`;
      progressText.textContent = `${progress}%`;
    }
  }, 200);
  
  try {
    const response = await fetch("{% url 'accounts:import_leads_excel' %}", {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: formData
    });
    
    clearInterval(progressInterval);
    progressBar.style.width = '100%';
    progressText.textContent = '100%';
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    console.log('Import response:', data);
    
    if (data.status === 'success') {
      showToast(`Successfully imported ${data.imported_count} leads!`, 'success');
      setTimeout(() => {
        closeImportModal();
        window.location.reload();
      }, 1500);
    } else {
      showToast(`Import failed: ${data.message}`, 'error');
      importButton.disabled = false;
      importButton.innerHTML = '<i class="fas fa-upload mr-1"></i> Import Leads';
    }
  } catch (error) {
    console.error('Import error:', error);
    clearInterval(progressInterval);
    showToast(`Import error: ${error.message}`, 'error');
    if (importButton) {
      importButton.disabled = false;
      importButton.innerHTML = '<i class="fas fa-upload mr-1"></i> Import Leads';
    }
  }
}
    </script>
<script>
  // Handle assignment to executives
document.querySelectorAll('.assign-select').forEach(select => {
  select.addEventListener('change', function() {
    const leadId = this.dataset.leadId;
    const executiveId = this.value;
    
    axios.post('{% url "accounts:assign_to_executive" %}', 
      JSON.stringify({
        lead_id: leadId,
        executive_id: executiveId
      }),
      {
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCookie('csrftoken') // Add CSRF token
        }
      }
    )
    .then(response => {
      console.log('Lead assigned successfully');
      // Update the row's data attribute for search
      const row = this.closest('tr');
      if (executiveId) {
        const selectedOption = this.options[this.selectedIndex];
        row.dataset.assigned = selectedOption.text.toLowerCase();
      } else {
        row.dataset.assigned = 'unassigned';
      }
      
      // Optional: Remove row if unassigned
      if (!executiveId) {
        row.remove();
      }
    })
    .catch(error => {
      console.error('Error assigning lead:', error.response?.data || error);
      // Show more detailed error message
      const errorMsg = error.response?.data?.message || 'Failed to assign lead. Please try again.';
      alert(errorMsg);
      // Revert the select to its previous value
      this.value = this.dataset.previousValue;
    });
  });
  
  // Store initial value
  select.dataset.previousValue = select.value;
});

// Helper function to get CSRF token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>
  <script>
  // Configure axios properly
  axios.defaults.xsrfCookieName = 'csrftoken';
  axios.defaults.xsrfHeaderName = 'X-CSRFToken';
  
  // Stats dropdown functionality
  const statsBtn = document.getElementById('statsBtn');
  const statsDropdown = document.getElementById('statsDropdown');
  const tableContainer = document.querySelector('.table-container');
  
  // Toggle stats dropdown
  statsBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    statsDropdown.classList.toggle('active');
    if (statsDropdown.classList.contains('active')) {
      updateStats();
      tableContainer.classList.add('blurred');
    } else {
      tableContainer.classList.remove('blurred');
    }
  });
  
  // Close dropdown when clicking outside
  document.addEventListener('click', function(e) {
    if (!statsBtn.contains(e.target) && !statsDropdown.contains(e.target)) {
      statsDropdown.classList.remove('active');
      tableContainer.classList.remove('blurred');
    }
  });
  
  // Function to calculate and update stats - Simplified for AM Dashboard
  function updateStats() {
    const visibleRows = Array.from(document.querySelectorAll('.table-row:not(.hidden)'));
    
    // Calculate only the stats we need
    let totalCount = 0;
    let registeredCount = 0;
    let interestedCount = 0;
    
    visibleRows.forEach(row => {
      totalCount++;
      const status = row.dataset.status || 'Unknown';
      
      if (status === 'registered') {
        registeredCount++;
      } else if (status === 'interested') {
        interestedCount++;
      }
    });
    
    // Update stats display - Simplified layout
    const statusStats = document.getElementById('statusStats');
    statusStats.innerHTML = '';
    
    // Add only the stats we want to show
    addStatItem(statusStats, 'Total', totalCount);
    addStatItem(statusStats, 'Registered', registeredCount);
    addStatItem(statusStats, 'Interested', interestedCount);
    
    // Hide the sections we don't need
    document.getElementById('programStats').innerHTML = '';
    document.getElementById('priorityStats').innerHTML = '';
  }
  
  // Helper function to add a stat item
  function addStatItem(container, label, value) {
    const statItem = document.createElement('div');
    statItem.className = 'stat-item';
    statItem.innerHTML = `
      <span class="label">${label}</span>
      <span class="value">${value}</span>
    `;
    container.appendChild(statItem);
  }
  
  // Enhanced Search functionality
  const searchInput = document.getElementById('searchInput');
  const clearSearchBtn = document.getElementById('clearSearch');
  const tableRows = document.querySelectorAll('.table-row');
  
  function performSearch() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    let visibleCount = 0;
    
    tableRows.forEach(row => {
      const name = row.dataset.name;
      const phone = row.dataset.phone;
      
      // Get program from both data attribute and input field
      const programInput = row.querySelector('.program-input');
      const programFromInput = programInput ? programInput.value.toLowerCase() : '';
      const programFromData = row.dataset.program || '';
      const program = programFromInput || programFromData;
      
      const status = row.dataset.status;
      const priority = row.dataset.priority;

      if (name.includes(searchTerm) ||
          phone.includes(searchTerm) ||
          program.includes(searchTerm) ||
          status.includes(searchTerm) ||
          priority.includes(searchTerm)) {
        row.classList.remove('hidden');
        visibleCount++;
      } else {
        row.classList.add('hidden');
      }
    });
    
    // Update serial numbers for visible rows
    updateSerialNumbers();
    
    // Show/hide clear button
    clearSearchBtn.style.display = searchTerm ? 'block' : 'none';
    
    // Show no results message if needed
    let noResultsRow = document.querySelector('.no-results-row');
    if (visibleCount === 0 && searchTerm) {
      if (!noResultsRow) {
        noResultsRow = document.createElement('tr');
        noResultsRow.className = 'no-results-row';
        noResultsRow.innerHTML = '<td colspan="9" class="no-results">No leads found matching your search</td>';
        document.querySelector('tbody').appendChild(noResultsRow);
      }
    } else if (noResultsRow) {
      noResultsRow.remove();
    }
    
    // Update stats if dropdown is open
    if (statsDropdown.classList.contains('active')) {
      updateStats();
    }
  }
  
  // Function to update serial numbers for visible rows
  function updateSerialNumbers() {
    const visibleRows = Array.from(document.querySelectorAll('.table-row:not(.hidden)'));
    visibleRows.forEach((row, index) => {
      const serialCell = row.querySelector('td:first-child');
      if (serialCell) {
        serialCell.textContent = index + 1;
      }
    });
      }
  
  // Search input event listener
  searchInput.addEventListener('input', performSearch);
  
  // Clear search functionality
  clearSearchBtn.addEventListener('click', () => {
    searchInput.value = '';
    performSearch();
    searchInput.focus();
  });
  
  function handleUpdate(endpoint, leadId, newValue, successCallback = null) {
      return axios.post(`/leads/${leadId}/${endpoint}/`, 
          JSON.stringify({ [endpoint.split('_')[1]]: newValue }),
          {
              headers: {
                  'Content-Type': 'application/json',
                  'X-Requested-With': 'XMLHttpRequest'
              }
          }
      )
      .then(response => {
          if (successCallback) successCallback();
          return response;
      });
  }
  
  // Update priority via AJAX
  document.querySelectorAll('.priority-select').forEach(select => {
      select.dataset.originalValue = select.value;
      select.addEventListener('change', function() {
          const leadId = this.dataset.leadId;
          const newPriority = this.value;
          
          handleUpdate('update_priority', leadId, newPriority, () => {
              this.dataset.originalValue = newPriority;
              const row = this.closest('tr');
              row.dataset.priority = newPriority.toLowerCase();
              
              // Update stats if dropdown is open
              if (statsDropdown.classList.contains('active')) {
                updateStats();
              }
              
              // Re-run search if there's an active search term
              if (searchInput.value.trim()) {
                performSearch();
              }
          }).catch(error => {
              console.error('Error updating priority:', error.response?.data || error);
              this.value = this.dataset.originalValue;
          });
      });
  });
  
  // Update status via AJAX
      document.querySelectorAll('.status-input').forEach(input => {
          input.dataset.originalValue = input.value;
          input.addEventListener('change', function() {
          const leadId = this.dataset.leadId;
          const newStatus = this.value;
              
              // Update the row's data attribute immediately for search
              const row = this.closest('tr');
              row.dataset.status = newStatus.toLowerCase();
          
          handleUpdate('update_status', leadId, newStatus, () => {
              this.dataset.originalValue = newStatus;
              
              // Update stats if dropdown is open
              if (statsDropdown.classList.contains('active')) {
                updateStats();
              }
              
              // Re-run search if there's an active search term
              if (searchInput.value.trim()) {
                performSearch();
              }
          }).catch(error => {
              console.error('Error updating status:', error.response?.data || error);
              this.value = this.dataset.originalValue;
                  // Revert the data attribute on error
                  row.dataset.status = this.dataset.originalValue.toLowerCase();
          });
      });
          
          // Also update on input for better responsiveness in search
          input.addEventListener('input', function() {
              const row = this.closest('tr');
              row.dataset.status = this.value.toLowerCase();
              
              if (searchInput.value.trim()) {
                performSearch();
              }
          });
  });
  
  // Enhanced program input handling with immediate search update
  document.querySelectorAll('.program-input').forEach(input => {
    input.dataset.originalValue = input.value;
    
    // Handle program updates
    input.addEventListener('change', function() {
      const leadId = this.dataset.leadId;
      const newProgram = this.value;
      
      handleUpdate('update_program', leadId, newProgram, () => {
        this.dataset.originalValue = newProgram;
        const row = this.closest('tr');
        row.dataset.program = newProgram.toLowerCase();
        
        // Update stats if dropdown is open
        if (statsDropdown.classList.contains('active')) {
          updateStats();
        }
        
        // Re-run search if there's an active search term
        if (searchInput.value.trim()) {
          performSearch();
        }
      }).catch(error => {
        console.error('Error updating program:', error.response?.data || error);
        this.value = this.dataset.originalValue;
      });
    });
    
    // Also trigger search on input (not just change) for better responsiveness
    input.addEventListener('input', function() {
      const row = this.closest('tr');
      // Temporarily update the dataset for search purposes
      row.dataset.program = this.value.toLowerCase();
      
      if (searchInput.value.trim()) {
        performSearch();
      }
    });
  });

  // Handle assignment to executives
  document.querySelectorAll('.assign-select').forEach(select => {
    select.addEventListener('change', function() {
      const leadId = this.dataset.leadId;
      const executiveId = this.value;
      
      axios.post('{% url "accounts:assign_to_executive" %}', 
        JSON.stringify({
          lead_id: leadId,
          executive_id: executiveId
        }),
        {
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
          }
        }
      )
      .then(response => {
        console.log('Lead assigned successfully');
        const row = this.closest('tr');
        if (executiveId) {
          const selectedOption = this.options[this.selectedIndex];
          row.dataset.assigned = selectedOption.text.toLowerCase();
        } else {
          row.dataset.assigned = 'unassigned';
        }
        
        if (!executiveId) {
          row.remove();
        }
      })
      .catch(error => {
        console.error('Error assigning lead:', error.response?.data || error);
        const errorMsg = error.response?.data?.message || 'Failed to assign lead. Please try again.';
        alert(errorMsg);
        this.value = this.dataset.previousValue;
      });
    });
    
    // Store initial value
    select.dataset.previousValue = select.value;
  });

  // Helper function to get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Handle remarks updates
  document.querySelectorAll('.remarks-input').forEach(input => {
    input.dataset.originalValue = input.value;
    input.addEventListener('change', function() {
      const leadId = this.dataset.leadId;
      const remarks = this.value;
      
      axios.post('{% url "accounts:update_lead_field" %}', 
        JSON.stringify({
          lead_id: leadId,
          field: 'remarks',
          value: remarks
        }),
        {
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          }
        }
      )
      .then(response => {
        this.dataset.originalValue = remarks;
      })
      .catch(error => {
        console.error('Error updating remarks:', error.response?.data || error);
        this.value = this.dataset.originalValue;
      });
    });
  });
</script>

<script>
  // Modal functionality
  const addLeadBtn = document.getElementById('addLeadBtn');
  const addLeadModal = document.getElementById('addLeadModal');
  const addLeadForm = document.getElementById('addLeadForm');

  // Open modal
  addLeadBtn.addEventListener('click', function() {
    addLeadModal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  });

  // Close modal
  function closeAddLeadModal() {
    addLeadModal.style.display = 'none';
    document.body.style.overflow = 'auto';
    addLeadForm.reset();
  }

  // Close modal when clicking outside
  addLeadModal.addEventListener('click', function(e) {
    if (e.target === addLeadModal) {
      closeAddLeadModal();
    }
  });

  // Handle form submission
  addLeadForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(addLeadForm);
    const leadData = {
      name: formData.get('name'),
      phone: formData.get('phone'),
      email: formData.get('email') || '',
      priority: formData.get('priority'),
      status: formData.get('status'),
      program: formData.get('program') || '',
      source: formData.get('source'),
      location: formData.get('location') || '',
      remarks: formData.get('remarks') || ''
    };

    // Send AJAX request to add lead
    axios.post('{% url "accounts:add_lead" %}', 
      JSON.stringify(leadData),
      {
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCookie('csrftoken')
        }
      }
    )
    .then(response => {
      console.log('Lead added successfully');
      closeAddLeadModal();
      
      // Show success message
      showToast('Lead added successfully!', 'success');
      
      // Reload the page to show the new lead
      setTimeout(() => {
        window.location.reload();
      }, 1000);
    })
    .catch(error => {
      console.error('Error adding lead:', error.response?.data || error);
      const errorMsg = error.response?.data?.message || 'Failed to add lead. Please try again.';
      showToast(errorMsg, 'error');
    });
  });

  // Toast notification function
  function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
    toast.textContent = message;
    toast.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      color: white;
      font-weight: 500;
      z-index: 10001;
      animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: ${type === 'success' ? 'linear-gradient(135deg, rgba(16, 185, 129, 0.9) 0%, rgba(16, 185, 129, 0.8) 100%)' : 'linear-gradient(135deg, rgba(239, 68, 68, 0.9) 0%, rgba(239, 68, 68, 0.8) 100%)'};
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.style.animation = 'slideOut 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  // Add CSS animations for toast
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideIn {
      from { 
        transform: translateX(100%) scale(0.95); 
        opacity: 0; 
      }
      to { 
        transform: translateX(0) scale(1); 
        opacity: 1; 
      }
    }
    @keyframes slideOut {
      from { 
        transform: translateX(0) scale(1); 
        opacity: 1; 
      }
      to { 
        transform: translateX(100%) scale(0.95); 
        opacity: 0; 
      }
    }
  `;
  document.head.appendChild(style);
  
  // Initialize serial numbers
  updateSerialNumbers();
</script>

<!-- Task Sidebar -->
<div id="taskSidebar" class="task-sidebar">
  <div class="task-sidebar-header">
    <h3>My Tasks</h3>
    <button class="task-close-btn" onclick="closeTaskSidebar()">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="task-sidebar-content">
    <div class="task-filters">
      <select id="taskStatusFilter" class="task-filter">
        <option value="">All Tasks</option>
        <option value="PENDING">Pending</option>
        <option value="IN_PROGRESS">In Progress</option>
        <option value="COMPLETED">Completed</option>
        <option value="OVERDUE">Overdue</option>
      </select>
      <select id="taskPriorityFilter" class="task-filter">
        <option value="">All Priorities</option>
        <option value="LOW">Low</option>
        <option value="MEDIUM">Medium</option>
        <option value="HIGH">High</option>
        <option value="URGENT">Urgent</option>
      </select>
    </div>
    <div class="task-list" id="taskList">
      <!-- Tasks will be loaded here -->
    </div>
  </div>
</div>

<script>
// Task Sidebar functionality
const tasksBtn = document.getElementById('tasksBtn');
const taskSidebar = document.getElementById('taskSidebar');
const taskList = document.getElementById('taskList');
const taskCount = document.getElementById('taskCount');

// Open task sidebar
if (tasksBtn) {
  tasksBtn.addEventListener('click', function() {
    taskSidebar.classList.add('active');
    loadTasks();
  });
}

// Close task sidebar
function closeTaskSidebar() {
  taskSidebar.classList.remove('active');
}

// Load tasks via AJAX
function loadTasks() {
  fetch('{% url "tasks:my_tasks_ajax" %}', {
    method: 'GET',
    headers: {
      'X-Requested-With': 'XMLHttpRequest',
      'X-CSRFToken': getCookie('csrftoken')
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      displayTasks(data.tasks);
      updateTaskCount(data.total_tasks);
    }
  })
  .catch(error => {
    console.error('Error loading tasks:', error);
    taskList.innerHTML = '<div class="task-error">Error loading tasks</div>';
  });
}

// Display tasks in sidebar
function displayTasks(tasks) {
  if (tasks.length === 0) {
    taskList.innerHTML = '<div class="task-empty">No tasks assigned</div>';
    return;
  }

  let tasksHTML = '';
  tasks.forEach(task => {
    const priorityClass = task.priority.toLowerCase();
    const statusClass = task.status.toLowerCase().replace('_', '-');
    const isOverdue = task.status === 'OVERDUE';
    const daysOverdue = task.overdue_days || 0;
    
    tasksHTML += `
      <div class="task-item ${statusClass} ${isOverdue ? 'overdue' : ''}" data-task-id="${task.id}">
        <div class="task-header">
          <h4 class="task-title">${task.title}</h4>
          <div class="task-badges">
            <span class="task-priority ${priorityClass}">${task.priority}</span>
            <span class="task-status ${statusClass}">${task.status.replace('_', ' ')}</span>
          </div>
        </div>
        <div class="task-description">${task.description}</div>
        <div class="task-meta">
          <div style="display: flex; flex-direction: column; gap: 0.5rem; flex: 1;">
            <div style="font-size: 0.8rem; color: var(--text-tertiary);">
              <i class="fas fa-user" style="margin-right: 0.25rem;"></i>
              <strong>Assigned by:</strong> ${task.assigned_by}
            </div>
            <div class="task-deadline">
              <i class="fas fa-clock"></i>
              Deadline:
              ${task.deadline}
              
            </div>
          </div>
          <div class="task-actions">
            <button class="action-btn view-btn" title="View Task" onclick="openTaskViewFromButton(this)" data-title="${task.title}" data-description="${(task.description || '').replace(/\"/g, '&quot;')}">
              <i class="fas fa-eye"></i>
            </button>
            <select class="task-status-select" onchange="updateTaskStatus(${task.id}, this.value)">
              <option value="PENDING" ${task.status === 'PENDING' ? 'selected' : ''}>Pending</option>
              <option value="IN_PROGRESS" ${task.status === 'IN_PROGRESS' ? 'selected' : ''}>In Progress</option>
              <option value="COMPLETED" ${task.status === 'COMPLETED' ? 'selected' : ''}>Completed</option>
            </select>
          </div>
        </div>
      </div>
    `;
  });

  taskList.innerHTML = tasksHTML;
}

// Update task count
function updateTaskCount(count) {
  if (count > 0) {
    taskCount.textContent = count;
    taskCount.style.display = 'inline';
  } else {
    taskCount.style.display = 'none';
  }
}

// Update task status
function updateTaskStatus(taskId, newStatus) {
  fetch(`/tasks/${taskId}/update-status/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Requested-With': 'XMLHttpRequest',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
      status: newStatus,
      notes: ''
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      loadTasks(); // Reload tasks
    } else {
      alert('Error updating task: ' + data.message);
    }
  })
  .catch(error => {
    console.error('Error updating task:', error);
    alert('Error updating task');
  });
}

// Filter tasks
document.getElementById('taskStatusFilter').addEventListener('change', filterTasks);
document.getElementById('taskPriorityFilter').addEventListener('change', filterTasks);

function filterTasks() {
  const statusFilter = document.getElementById('taskStatusFilter').value;
  const priorityFilter = document.getElementById('taskPriorityFilter').value;
  const taskItems = document.querySelectorAll('.task-item');

  taskItems.forEach(item => {
    const taskStatus = item.dataset.status || '';
    const taskPriority = item.dataset.priority || '';
    
    const statusMatch = !statusFilter || taskStatus === statusFilter;
    const priorityMatch = !priorityFilter || taskPriority === priorityFilter;
    
    if (statusMatch && priorityMatch) {
      item.style.display = 'block';
    } else {
      item.style.display = 'none';
    }
  });
}

// Load tasks on page load
document.addEventListener('DOMContentLoaded', function() {
  loadTasks();
});
</script>

<!-- Task View Modal -->
<div id="taskViewModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10002; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
  <div class="modal-content" style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 16px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto;">
    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
      <h2 id="taskViewTitle" class="modal-title" style="font-size: 1.5rem; font-weight: 600; margin: 0;">Task</h2>
      <button class="modal-close" onclick="closeTaskViewModal()" style="background: transparent; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; padding: 0.5rem; border-radius: 8px;">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body" style="padding: 1.5rem;">
      <div id="taskViewDescription" style="color: var(--text-secondary); line-height: 1.6; white-space: pre-wrap;"></div>
    </div>
  </div>
  
</div>

<script>
  function openTaskViewFromButton(btn) {
    const title = btn.getAttribute('data-title') || '';
    const description = btn.getAttribute('data-description') || '';
    openTaskViewModal(title, description);
  }
  function openTaskViewModal(title, description) {
    const modal = document.getElementById('taskViewModal');
    if (!modal) return;
    const titleEl = document.getElementById('taskViewTitle');
    const descEl = document.getElementById('taskViewDescription');
    if (titleEl) titleEl.textContent = title;
    if (descEl) descEl.textContent = description || 'No description provided.';
    modal.style.display = 'flex';
  }
  function closeTaskViewModal() {
    const modal = document.getElementById('taskViewModal');
    if (modal) modal.style.display = 'none';
  }
  (function(){
    const modal = document.getElementById('taskViewModal');
    if (modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) closeTaskViewModal();
      });
    }
  })();
</script>
</body>
</html>