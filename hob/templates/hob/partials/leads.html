<div class="table-container">
    <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <div style="display: flex; align-items: center; gap: 0.75rem;">
           
            <span id="visibleCount" style="font-size: 1.0rem;color: white;font-weight: 600;">&nbsp;</span>
        </div>
        
        <!-- Add Lead and Filters -->
        <div style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;">
            <!-- Search Bar -->
            <div style="position: relative;">
                <input type="text" id="nameSearch" oninput="filterLeads()" placeholder="Search by name..." 
                       style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem 2.5rem 0.5rem 2.5rem; font-size: 0.9rem; min-width: 200px;">
                <i class="fas fa-search" style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary); font-size: 0.9rem;"></i>
                <button type="button" onclick="clearSearch()" style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 0.25rem; border-radius: 4px; display: none;" id="clearSearchBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Source Filter -->
            <select id="sourceFilter" onchange="filterLeads()" style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem; font-size: 0.9rem;">
                <option value="">All Sources</option>
                {% for value, label in source_choices %}
                    <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
            </select>
            
            <!-- Status Filter -->
            <input type="text" id="statusFilter" oninput="filterLeads()" placeholder="Filter by status..." list="status-suggestions"
                   style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem; font-size: 0.9rem; min-width: 160px;">
            
            <!-- Staff Filter -->
            <select id="staffFilter" onchange="filterLeads()" style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem; font-size: 0.9rem;">
                <option value="">All Staff</option>
                <option value="unassigned">Unassigned</option>
                {% for staff in staff_members %}
                    <option value="{{ staff.id }}">{{ staff.get_full_name }}</option>
                {% endfor %}
            </select>
            <button class="add-leads-btn" id="importExcelBtn" onclick="openImportModal()" style="background: var(--accent); color: var(--bg-primary); border-color: var(--accent);">
                <i class="fas fa-file-excel"></i>
                <span>Import Excel</span>
            </button>
            <button class="add-leads-btn" id="addLeadBtn" style="background: var(--accent); color: var(--bg-primary); border-color: var(--accent);">
                <i class="fas fa-plus"></i>
                <span>Add Lead</span>
            </button>
        </div>
    </div>
    
    <div class="table-scroll-vert">
        <table class="bc-table bc-table-striped" id="leadsTable">
            <thead>
                <tr>
                    <th style="width: 60px">#</th>
                    <th>Name</th>
                    <th>Phone</th>
                    <th>Source</th>
                    <th>Status</th>
                    <th>Program</th>
                    <th>Assigned To</th>
                    <th>Created</th>
                </tr>
            </thead>
            <tbody id="leadsTableBody">
                {% for lead in leads %}
                <tr class="lead-row" 
                    data-source="{{ lead.source }}"
                    data-status="{{ lead.status|lower }}"
                    data-staff="{{ lead.assigned_to.id|default:'' }}"
                    data-program="{{ lead.program|default:''|lower }}"
                    data-name="{{ lead.name|lower }}">
                    <td style="text-align: center; font-weight: 600; color: var(--text-secondary);">{{ forloop.counter }}</td>
                    <td>
                        <a href="{% url 'accounts:lead_details' lead.id %}" style="color: var(--accent); text-decoration: none; font-weight: 500;">
                            {{ lead.name }}
                        </a>
                    </td>
                    <td>{{ lead.phone }}</td>
                    <td>
                        <span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; background: rgba(59, 130, 246, 0.2); color: #93c5fd;">
                            {{ lead.source }}
                        </span>
                    </td>
                    
                    <!-- Status Column -->
                    <td>
                        <input type="text" class="status-input hob-assignment" 
                               data-lead-id="{{ lead.id }}" 
                               value="{{ lead.status|default:'' }}" 
                               placeholder="Enter status" 
                               list="status-suggestions"
                               style="width: 100%; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.35rem 0.7rem; font-size: 0.9rem;" />
                    </td>
                    
                    <!-- Program Column -->
                    <td>
                        <input type="text" class="program-input hob-assignment" 
                               data-lead-id="{{ lead.id }}" 
                               value="{{ lead.program|default:'' }}" 
                               placeholder="Enter program"
                               style="width: 100%; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.35rem 0.7rem; font-size: 0.9rem;" />
                    </td>
                    
                    <!-- Assignment Column -->
                    <td>
                        <select class="editable-select assign-select hob-assignment" 
                                data-lead-id="{{ lead.id }}"
                                data-field="assigned_to">
                            <option value="">Unassigned</option>
                            
                            <!-- Admission Managers Group -->
                            <optgroup label="Admission Managers">
                                {% for manager in admission_managers %}
                                <option value="{{ manager.id }}" 
                                        {% if lead.assigned_to == manager %}selected{% endif %}>
                                    {{ manager.get_full_name }} (Manager)
                                </option>
                                {% endfor %}
                            </optgroup>
                            
                            <!-- Admission Executives Group -->
                            <optgroup label="Admission Executives">
                                {% for executive in admission_executives %}
                                <option value="{{ executive.id }}" 
                                        {% if lead.assigned_to == executive %}selected{% endif %}>
                                    {{ executive.get_full_name }} (Executive)
                                </option>
                                {% endfor %}
                            </optgroup>
                        </select>
                    </td>
                    
                    <td>{{ lead.created_at|date:"M d, Y" }}</td>
                </tr>
                {% empty %}
                <tr id="noLeadsRow">
                    <td colspan="8" style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                        No leads found
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add Lead Modal -->
<div id="addLeadModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Add New Lead</h2>
            <button type="button" class="modal-close" aria-label="Close add lead dialog">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="addLeadForm" style="display: flex; flex-direction: column; flex: 1;">
            {% csrf_token %}
            <div style="padding: 1.5rem; flex: 1; overflow-y: auto; min-height: 0;">
                <div class="form-field">
                    <label for="leadName">Name *</label>
                    <input type="text" id="leadName" name="name" class="form-input" required placeholder="Enter lead name">
                    </div>
                
                <div class="form-field">
                    <label for="leadPhone">Phone *</label>
                    <input type="tel" id="leadPhone" name="phone" class="form-input" required placeholder="Enter phone number">
                </div>
                
                <div class="form-field">
                    <label for="leadEmail">Email</label>
                    <input type="email" id="leadEmail" name="email" class="form-input" placeholder="Enter email address">
                    </div>
                
                <div class="form-field">
                    <label for="leadLocation">Location</label>
                    <input type="text" id="leadLocation" name="location" class="form-input" placeholder="Enter location">
                </div>
                
                <div class="form-field">
                    <label for="leadProgram">Program</label>
                    <input type="text" id="leadProgram" name="program" class="form-input" placeholder="Enter program/course">
                        </div>
                
                <div class="form-field">
                    <label for="leadPriority">Priority</label>
                    <select id="leadPriority" name="priority" class="form-select">
                        <option value="MEDIUM">Medium</option>
                        <option value="HIGH">High</option>
                        <option value="LOW">Low</option>
                    </select>
                    </div>
                
                <div class="form-field">
                    <label for="leadStatus">Status</label>
                    <input type="text" id="leadStatus" name="status" class="form-input" placeholder="Enter status" list="status-suggestions" value="ENQUIRY">
                </div>
                
                <div class="form-field">
                    <label for="leadSource">Source</label>
                    <select id="leadSource" name="source" class="form-select">
                        {% for value, label in source_choices %}
                            <option value="{{ value }}" {% if value == 'WHATSAPP' %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-field">
                    <label for="leadRemarks">Remarks</label>
                    <textarea id="leadRemarks" name="remarks" class="form-textarea" placeholder="Enter any additional remarks"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-notes" onclick="closeAddLeadModal()">Cancel</button>
                <button type="submit" class="btn btn-contact" id="addLeadButton">
                    <i class="fas fa-plus mr-1"></i> Add Lead
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Import Excel Modal -->
<div id="importExcelModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Import Leads from Excel</h2>
            <button type="button" class="modal-close" aria-label="Close import dialog">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="importExcelForm" enctype="multipart/form-data" style="display: flex; flex-direction: column; flex: 1;">
            {% csrf_token %}
            <div style="padding: 1.5rem; flex: 1; overflow-y: auto; min-height: 0;">
                <div class="form-field" style="margin-bottom: 1rem;">
                    <div style="display: inline-flex; gap: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border-color); padding: 0.25rem; border-radius: 0.5rem;">
                        <button type="button" id="tabUpload" class="btn" style="padding: 0.35rem 0.75rem;">Upload Excel</button>
                        <button type="button" id="tabPaste" class="btn" style="padding: 0.35rem 0.75rem;">Paste Rows</button>
                    </div>
                </div>
                <div class="form-field" id="uploadSection">
                    <label for="excel_file">Select Excel File</label>
                    <input type="file" id="excel_file" name="excel_file" accept=".xlsx, .xls" class="form-input" required>
                    <div class="field-info" style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.5rem;">
                        <p>‚úÖ Supported formats: .xlsx, .xls</p>
                        <p>üìù Leads will be automatically assigned to you</p>
                        <p>üì• Download <a href="{% url 'accounts:download_excel_template' %}" style="color: var(--accent); text-decoration: underline;">Excel template</a> for reference</p>
                    </div>
                </div>
                <div class="form-field" id="pasteSection" style="display: none;">
                    <label for="pasted_rows">Paste table rows (CSV/TSV)</label>
                    <textarea id="pasted_rows" name="pasted_rows" class="form-textarea" placeholder="Paste rows with headers here (CSV or tab-separated)"></textarea>
                    <div class="field-info" style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.5rem;">
                        <p>üß© Required columns: name, phone (case-insensitive). Optional: email, location, program, priority, status, source, remarks</p>
                        <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                            <button type="button" id="previewPasteBtn" class="btn btn-notes" onclick="previewPastedRowsGlobal()">Preview Pasted Rows</button>
                            <button type="button" id="clearPasteBtn" class="btn" onclick="globalClearPaste()">Clear</button>
                        </div>
                    </div>
                </div>
                <div id="previewSection" style="display: none; margin-top: 1rem; margin-bottom: 1rem;">
                    <h3 style="font-size: 1rem; margin-bottom: 0.5rem; color: var(--text-secondary);">Preview (First 5 rows)</h3>
                    <div id="previewTable" class="table-scroll-vert" style="max-height: 200px; font-size: 0.75rem; background: var(--bg-secondary); border-radius: 8px; padding: 0.5rem; overflow-y: auto;"></div>
                    <div id="previewStats" style="margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.75rem;"></div>
                </div>
                <div id="importProgress" style="display: none; margin-top: 1rem; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: var(--text-secondary);">Importing...</span>
                        <span id="progressText" style="color: var(--accent); font-weight: 600;">0%</span>
                    </div>
                    <div style="background: var(--bg-secondary); border-radius: 4px; height: 8px;">
                        <div id="progressBar" style="background: var(--accent); height: 100%; width: 0%; border-radius: 4px; transition: width 0.3s;"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-notes" onclick="closeImportModal()">Cancel</button>
                <button type="button" class="btn btn-contact" id="importButton" onclick="globalHandleExcelImport(event)">
                    <i class="fas fa-upload mr-1"></i> Import Leads
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Status suggestions shared with overview/status vocabulary -->
<datalist id="status-suggestions">
    <option value="ENQUIRY">
    <option value="INTERESTED">
    <option value="NOT_INTERESTED">
    <option value="WALK_IN">
    <option value="ON_HOLD">
    <option value="REGISTERED">
    <option value="FOLLOW_UP">
    <option value="CONVERTED">
    <option value="LOST">
    <option value="COLD">
    <option value="WARM">
    <option value="HOT">
    <option value="Enquiry">
    <option value="Interested">
    <option value="Not Interested">
    <option value="Walk In">
    <option value="On Hold">
    <option value="Registered">
    <option value="Follow Up">
    <option value="Converted">
    <option value="Lost">
    <option value="Cold">
    <option value="Warm">
    <option value="Hot">
</datalist>

<script>
// CSRF helper for axios
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

// Configure axios
axios.defaults.headers.common['X-CSRFToken'] = getCookie('csrftoken');
axios.defaults.xsrfCookieName = 'csrftoken';
axios.defaults.xsrfHeaderName = 'X-CSRFToken';

// Add Lead Modal functionality
const addLeadBtn = document.getElementById('addLeadBtn');
const addLeadModal = document.getElementById('addLeadModal');
const addLeadForm = document.getElementById('addLeadForm');

// Open add lead modal
// Use event delegation so the Add Lead button continues to work after partial DOM reloads
// This avoids lost event listeners when the tab content is replaced dynamically.
document.addEventListener('click', function(e) {
    const btn = e.target.closest('#addLeadBtn');
    if (!btn) return;
    const modal = document.getElementById('addLeadModal');
    if (!modal) return;
    console.log('Add lead button clicked (delegated)');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    resetAddLeadForm();
    // Ensure close handlers are attached after modal opens
    bindModalCloseHandlers();
});

// Close add lead modal
function closeAddLeadModal() {
    console.log('Closing add lead modal');
    const modal = document.getElementById('addLeadModal');
    if (!modal) return;
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
    resetAddLeadForm();
}

function resetAddLeadForm() {
    const form = document.getElementById('addLeadForm');
    if (form) {
        form.reset();
        // Set default values
        document.getElementById('leadStatus').value = 'ENQUIRY';
        document.getElementById('leadPriority').value = 'MEDIUM';
    }
}

// Bind persistent handlers to modal-close buttons. Runs whenever modals are opened or when DOM changes.
function bindModalCloseHandlers() {
    const buttons = document.querySelectorAll('.modal-close');
    if (!buttons || buttons.length === 0) {
        console.log('[bind] no .modal-close found');
        return;
    }
    buttons.forEach(btn => {
        if (btn.dataset.bound === 'true') return; // already bound
        btn.dataset.bound = 'true';
        // Direct click listener (capture) to ensure we get it even if other handlers stop propagation
        btn.addEventListener('click', function(ev) {
            console.log('[bind] modal-close direct click', {btn: btn, target: ev.target});
            const modal = btn.closest('.modal');
            if (modal && modal.id === 'addLeadModal') return closeAddLeadModal();
            if (modal && modal.id === 'importExcelModal') return closeImportModal();
            if (modal) { modal.style.display = 'none'; document.body.style.overflow = 'auto'; }
        }, true);
    });
}


function filterLeads() {
    const sourceFilter = document.getElementById('sourceFilter').value;
    const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
    const staffFilter = document.getElementById('staffFilter').value;
    const nameSearch = document.getElementById('nameSearch').value.toLowerCase();

    const tableBody = document.getElementById('leadsTableBody');
    const rows = tableBody.querySelectorAll('.lead-row');
    const noLeadsRow = document.getElementById('noLeadsRow');
    let visibleCount = 0;

    // Show/hide clear search button
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    if (clearSearchBtn) {
        clearSearchBtn.style.display = nameSearch ? 'block' : 'none';
    }

    // First, hide the "no leads" row if it exists
    if (noLeadsRow) {
        noLeadsRow.style.display = 'none';
    }

    // Filter each row and update serial numbers
    rows.forEach((row, index) => {
        const source = row.dataset.source || '';
        const status = row.dataset.status || '';
        const staff = row.dataset.staff || '';
        const priority = row.dataset.priority || '';
        const program = row.dataset.program || '';
        const name = row.dataset.name || '';

        const sourceMatch = !sourceFilter || source === sourceFilter;
        const statusMatch = !statusFilter || status.includes(statusFilter);
        
        // Handle staff filter including 'unassigned' option
        let staffMatch = true;
        if (staffFilter) {
            if (staffFilter === 'unassigned') {
                staffMatch = staff === '';
            } else {
                staffMatch = staff === staffFilter;
            }
        }
        
        const nameMatch = !nameSearch || name.includes(nameSearch);

        if (sourceMatch && statusMatch && staffMatch && nameMatch) {
            row.style.display = '';
            // Update the serial number for visible rows
            const serialCell = row.querySelector('td:first-child');
            if (serialCell) {
                serialCell.textContent = visibleCount + 1;
            }
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    // Update visible count
    const totalCount = rows.length;
    const countEl = document.getElementById('visibleCount');
    if (countEl) {
        if (visibleCount === totalCount) {
            countEl.textContent = `(${totalCount} leads)`;
        } else {
            countEl.textContent = `(Showing ${visibleCount} of ${totalCount})`;
        }
    }

    // Show appropriate message based on results
    if (visibleCount === 0) {
        // Check if we have any leads at all
        if (totalCount === 0) {
            // No leads in the system
            if (noLeadsRow) {
                noLeadsRow.style.display = '';
            }
        } else {
            // Leads exist but none match filters
            let noResultsRow = tableBody.querySelector('.no-results-message');
            if (!noResultsRow) {
                noResultsRow = document.createElement('tr');
                noResultsRow.className = 'no-results-message';
                noResultsRow.innerHTML = '<td colspan="8" style="text-align: center; color: var(--text-secondary); padding: 2rem;">No leads match the selected filters</td>';
                tableBody.appendChild(noResultsRow);
            }
            noResultsRow.style.display = '';
        }
    } else {
        // Remove no results message if it exists
        const noResultsRow = tableBody.querySelector('.no-results-message');
        if (noResultsRow) {
            noResultsRow.style.display = 'none';
        }
    }
}

function clearSearch() {
    document.getElementById('nameSearch').value = '';
    filterLeads();
}

function resetLeadFilters() {
    document.getElementById('sourceFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('staffFilter').value = '';
    document.getElementById('nameSearch').value = '';
    filterLeads();
}

// HOB Assignment functionality
function initializeHOBAssignment() {
    // Handle all field updates (priority, assignment, etc.)
    document.querySelectorAll('.hob-assignment').forEach(element => {
        if (element.tagName === 'SELECT') {
            // Store initial value
            element.dataset.previousValue = element.value;
            
            element.addEventListener('change', function() {
                console.log('[HOB] select changed', {
                    leadId: this.dataset.leadId,
                    field: this.dataset.field,
                    value: this.value
                });
                handleHOBFieldUpdate(this);
            });
        }
    });
    
    // Handle free-text status input updates
    document.querySelectorAll('.status-input.hob-assignment').forEach(input => {
        input.dataset.originalValue = input.value;
        
        const commitChange = () => {
            const leadId = input.dataset.leadId;
            const newStatus = (input.value || '').trim();
            
            if (!newStatus) {
                showHOBToast('Status cannot be empty', 'error');
                input.value = input.dataset.originalValue;
                return;
            }
            
            updateHOBLeadField(leadId, 'status', newStatus)
                .then(() => {
                    input.dataset.originalValue = newStatus;
                    // Update row dataset for search
                    const row = input.closest('tr');
                    if (row) {
                        row.dataset.status = newStatus.toLowerCase();
                    }
                    showHOBToast('Status updated successfully', 'success');
                })
                .catch((error) => {
                    input.value = input.dataset.originalValue;
                    showHOBToast('Failed to update status', 'error');
                });
        };
        
        input.addEventListener('blur', commitChange);
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                commitChange();
                input.blur();
            }
            if (e.key === 'Escape') {
                input.value = input.dataset.originalValue;
                input.blur();
            }
        });
    });
    
    // Handle program input updates
    document.querySelectorAll('.program-input.hob-assignment').forEach(input => {
        input.dataset.originalValue = input.value;
        
        input.addEventListener('change', function() {
            const leadId = this.dataset.leadId;
            const newProgram = this.value;
            
            updateHOBLeadField(leadId, 'program', newProgram)
                .then(() => {
                    this.dataset.originalValue = newProgram;
                    const row = this.closest('tr');
                    if (row) {
                        row.dataset.program = newProgram.toLowerCase();
                    }
                    showHOBToast('Program updated successfully', 'success');
                })
                .catch((error) => {
                    this.value = this.dataset.originalValue;
                    showHOBToast('Failed to update program', 'error');
                });
        });
    });
}

// Generic function to handle field updates
function handleHOBFieldUpdate(selectElement) {
    const leadId = selectElement.dataset.leadId;
    const field = selectElement.dataset.field;
    const value = selectElement.value;
    console.log('[HOB] handleHOBFieldUpdate', { leadId, field, value });
    
    updateHOBLeadField(leadId, field, value)
        .then((response) => {
            console.log('[HOB] updateHOBLeadField success', response);
            console.log(`${field} updated successfully`);
            
            // Update the data attributes for search functionality
            const row = selectElement.closest('tr');
            updateHOBRowSearchData(row, field, value);
            
            // Update stored value
            selectElement.dataset.previousValue = value;
            
            // Show success message
            let fieldName = field.replace('_', ' ');
            fieldName = fieldName.charAt(0).toUpperCase() + fieldName.slice(1);
            showHOBToast(`${fieldName} updated successfully`, 'success');
        })
        .catch((error) => {
            console.error(`[HOB] Error updating ${field}:`, error?.response?.data || error);
            // Show error message
            if (error.response && error.response.data && error.response.data.message) {
                showHOBToast(error.response.data.message, 'error');
            } else {
                showHOBToast(`Failed to update ${field}`, 'error');
            }
            // Revert to previous value
            selectElement.value = selectElement.dataset.previousValue;
        });
}

// AJAX function to update lead fields - HOB specific
function updateHOBLeadField(leadId, field, value) {
    return new Promise((resolve, reject) => {
        console.log('[HOB] POST -> hob_assign_lead', { leadId, field, value });
        axios.post('{% url "hob:hob_assign_lead" %}', 
            JSON.stringify({
                lead_id: leadId,
                field: field,
                value: value
            }),
            {
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            }
        )
        .then(response => {
            console.log('[HOB] assign response', response?.data);
            resolve(response.data);
        })
        .catch(error => {
            console.error('[HOB] assign error', error?.response?.data || error);
            reject(error);
        });
    });
}

// Update row search data when fields change
function updateHOBRowSearchData(row, field, value) {
    if (field === 'assigned_to') {
        if (value === '') {
            row.dataset.staff = '';
        } else {
            row.dataset.staff = value;
        }
    } else if (field === 'priority') {
        row.dataset.priority = value.toLowerCase();
    }
    
    // Re-run search if there's an active filter
    filterLeads();
}

// Toast notification for HOB
function showHOBToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    
    if (type === 'success') {
        toast.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.9) 0%, rgba(16, 185, 129, 0.8) 100%)';
    } else if (type === 'error') {
        toast.style.background = 'linear-gradient(135deg, rgba(239, 68, 68, 0.9) 0%, rgba(239, 68, 68, 0.8) 100%)';
    }
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Handle add lead form submission
if (addLeadForm) {
    addLeadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('Add lead form submitted');
        handleAddLead();
    });
}

// Handle add lead
async function handleAddLead() {
    console.log('Handling add lead');
    
    const form = document.getElementById('addLeadForm');
    const addButton = document.getElementById('addLeadButton');
    
    if (!form || !addButton) {
        console.error('Form elements not found');
        showHOBToast('Form error - please refresh the page', 'error');
        return;
    }
    
    // Get form data
    const formData = new FormData(form);
    const leadData = {
        name: formData.get('name'),
        phone: formData.get('phone'),
        email: formData.get('email') || '',
        location: formData.get('location') || '',
        program: formData.get('program') || '',
        priority: formData.get('priority'),
        status: formData.get('status'),
        source: formData.get('source'),
        remarks: formData.get('remarks') || ''
    };
    
    // Validate required fields
    if (!leadData.name || !leadData.phone) {
        showHOBToast('Name and phone are required', 'error');
        return;
    }
    
    if (leadData.phone.length < 10) {
        showHOBToast('Phone number must be at least 10 digits', 'error');
        return;
    }
    
    addButton.disabled = true;
    addButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Adding...';
    
    try {
        const csrfToken = getCookie('csrftoken');
        console.log('Add lead CSRF Token:', csrfToken);
        console.log('Lead data:', leadData);

        const response = await fetch("{% url 'accounts:add_lead' %}", {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(leadData)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Add lead response:', data);
        
        if (data.status === 'success') {
            showHOBToast('Lead added successfully!', 'success');
            setTimeout(() => {
                closeAddLeadModal();
                // Reload only the Leads tab if tab loader is available
                if (typeof window.loadTabContent === 'function') {
                    window.loadTabContent('leads');
                } else {
                    window.location.reload();
                }
            }, 1500);
        } else {
            showHOBToast(`Failed to add lead: ${data.message}`, 'error');
            addButton.disabled = false;
            addButton.innerHTML = '<i class="fas fa-plus mr-1"></i> Add Lead';
        }
    } catch (error) {
        console.error('Add lead error:', error);
        showHOBToast(`Error adding lead: ${error.message}`, 'error');
        addButton.disabled = false;
        addButton.innerHTML = '<i class="fas fa-plus mr-1"></i> Add Lead';
    }
}

// Import Excel Modal Functions
function openImportModal() {
    const importExcelModal = document.getElementById('importExcelModal');
    if (importExcelModal) {
        importExcelModal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        resetImportForm();
        initializeImportTabs();
        // Ensure close handlers are attached for import modal too
        bindModalCloseHandlers();
    }
}

function closeImportModal() {
    console.log('Closing import modal');
    const importExcelModal = document.getElementById('importExcelModal');
    if (!importExcelModal) return;
    importExcelModal.style.display = 'none';
    document.body.style.overflow = 'auto';
    resetImportForm();
}

function resetImportForm() {
    const excelFileInput = document.getElementById('excel_file');
    const pastedTextarea = document.getElementById('pasted_rows');
    const previewSection = document.getElementById('previewSection');
    const importProgress = document.getElementById('importProgress');
    const importButton = document.getElementById('importButton');
    
    if (excelFileInput) excelFileInput.value = '';
    if (pastedTextarea) pastedTextarea.value = '';
    if (previewSection) previewSection.style.display = 'none';
    if (importProgress) importProgress.style.display = 'none';
    if (importButton) {
        importButton.disabled = false;
        importButton.innerHTML = '<i class="fas fa-upload mr-1"></i> Import Leads';
    }
    
    // Reset to upload tab by default
    initializeImportTabs();
}

// Tab Switching Functions
function activateUploadTab() {
    const tabUpload = document.getElementById('tabUpload');
    const tabPaste = document.getElementById('tabPaste');
    const uploadSection = document.getElementById('uploadSection');
    const pasteSection = document.getElementById('pasteSection');
    const fileInput = document.getElementById('excel_file');
    
    if (tabUpload) tabUpload.classList.add('active-tab');
    if (tabPaste) tabPaste.classList.remove('active-tab');
    if (uploadSection) uploadSection.style.display = 'block';
    if (pasteSection) pasteSection.style.display = 'none';
    if (fileInput) fileInput.required = true;
    
    // Reset the other section
    const pastedTextarea = document.getElementById('pasted_rows');
    if (pastedTextarea) pastedTextarea.value = '';
}

function activatePasteTab() {
    const tabUpload = document.getElementById('tabUpload');
    const tabPaste = document.getElementById('tabPaste');
    const uploadSection = document.getElementById('uploadSection');
    const pasteSection = document.getElementById('pasteSection');
    const fileInput = document.getElementById('excel_file');
    
    if (tabPaste) tabPaste.classList.add('active-tab');
    if (tabUpload) tabUpload.classList.remove('active-tab');
    if (uploadSection) uploadSection.style.display = 'none';
    if (pasteSection) pasteSection.style.display = 'block';
    if (fileInput) fileInput.required = false;
    
    // Reset the other section
    if (fileInput) fileInput.value = '';
}

// Initialize tabs properly
function initializeImportTabs() {
    const tabUpload = document.getElementById('tabUpload');
    const tabPaste = document.getElementById('tabPaste');
    
    if (tabUpload && tabPaste) {
        // Remove any existing event listeners first
        const newTabUpload = tabUpload.cloneNode(true);
        const newTabPaste = tabPaste.cloneNode(true);
        
        tabUpload.parentNode.replaceChild(newTabUpload, tabUpload);
        tabPaste.parentNode.replaceChild(newTabPaste, tabPaste);
        
        // Add new event listeners
        newTabUpload.addEventListener('click', activateUploadTab);
        newTabPaste.addEventListener('click', activatePasteTab);
        
        // Set initial state
        activateUploadTab();
    }
}

// Global Import Functions
function globalHandleExcelImport(e) {
    e && e.preventDefault && e.preventDefault();
    const fileInput = document.getElementById('excel_file');
    const importButton = document.getElementById('importButton');
    const importProgress = document.getElementById('importProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const pastedTextarea = document.getElementById('pasted_rows');
    const hasFile = fileInput && fileInput.files && fileInput.files.length > 0;
    const hasPasted = pastedTextarea && pastedTextarea.value.trim().length > 0;
    
    if (!hasFile && !hasPasted) {
        showHOBToast('Please select a file or paste rows to import', 'error');
        return;
    }
    
    const formData = new FormData();
    if (hasFile) {
        formData.append('excel_file', fileInput.files[0]);
    } else {
        formData.append('pasted_data', pastedTextarea.value);
    }
    
    if (!importButton || !importProgress || !progressBar || !progressText) {
        showHOBToast('Import system error - please refresh the page', 'error');
        return;
    }
    
    importButton.disabled = true;
    importButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Importing...';
    importProgress.style.display = 'block';
    
    let progress = 0;
    const interval = setInterval(() => {
        progress += 5;
        if (progress <= 90) {
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${progress}%`;
        }
    }, 200);
    
    fetch("{% url 'accounts:import_leads_excel' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    }).then(async (response) => {
        clearInterval(interval);
        progressBar.style.width = '100%';
        progressText.textContent = '100%';
        
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        
        if (data.status === 'success') {
            showHOBToast(`Successfully imported ${data.imported_count} leads! They are now assigned to you.`, 'success');
            setTimeout(() => {
                closeImportModal();
                if (typeof window.loadTabContent === 'function') {
                    window.loadTabContent('leads');
                } else {
                    window.location.reload();
                }
            }, 1500);
        } else {
            showHOBToast(`Import failed: ${data.message}`, 'error');
            importButton.disabled = false;
            importButton.innerHTML = '<i class="fas fa-upload mr-1"></i> Import Leads';
        }
    }).catch(error => {
        clearInterval(interval);
        showHOBToast(`Import error: ${error.message}`, 'error');
        importButton.disabled = false;
        importButton.innerHTML = '<i class="fas fa-upload mr-1"></i> Import Leads';
    });
}

function previewPastedRowsGlobal() {
    const previewSection = document.getElementById('previewSection');
    const previewTable = document.getElementById('previewTable');
    const previewStats = document.getElementById('previewStats');
    const pastedTextarea = document.getElementById('pasted_rows');
    const text = pastedTextarea ? pastedTextarea.value : '';
    
    if (!text || !text.trim()) {
        showHOBToast('Please paste some rows first', 'error');
        return;
    }
    
    if (!previewSection || !previewTable) return;
    
    previewSection.style.display = 'block';
    previewTable.innerHTML = '<div style="text-align: center; padding: 1rem; color: var(--text-secondary);">Parsing preview...</div>';
    if (previewStats) previewStats.innerHTML = '';
    
    const formData = new FormData();
    formData.append('pasted_data', text);
    formData.append('preview_only', 'true');
    
    fetch("{% url 'accounts:import_leads_excel' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    }).then(r => {
        if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
        return r.json();
    }).then(data => {
        if (data.status === 'success') {
            const headers = data.preview_data.headers || [];
            const rows = data.preview_data.rows || [];
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse; font-size: 0.7rem;">
                    <thead>
                        <tr style="background: var(--bg-secondary);">
                            ${headers.map(h => `<th style="padding: 0.5rem; border: 1px solid var(--border-color); text-align: left;">${h}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${rows.map(row => `
                            <tr>
                                ${row.map(cell => `<td style="padding: 0.5rem; border: 1px solid var(--border-color);">${cell || ''}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            previewTable.innerHTML = tableHTML;
            
            if (previewStats) {
                const stats = data.stats || { total_rows: 0, valid_rows: 0, invalid_rows: 0 };
                let statsHTML = `
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <div><strong>Total rows:</strong> ${stats.total_rows}</div>
                        <div style="color: #22c55e;"><strong>Valid rows:</strong> ${stats.valid_rows}</div>
                        ${stats.invalid_rows > 0 ? `<div style="color: #f59e0b;"><strong>Invalid rows:</strong> ${stats.invalid_rows}</div>` : ''}
                    </div>
                `;
                previewStats.innerHTML = statsHTML;
            }
        } else {
            previewTable.innerHTML = `<div style="color: #ef4444; text-align: center; padding: 1rem;">Error: ${data.message}</div>`;
        }
    }).catch(error => {
        previewTable.innerHTML = `<div style="color: #ef4444; text-align: center; padding: 1rem;">Error loading preview: ${error.message}</div>`;
    });
}

function globalClearPaste() {
    const pastedTextarea = document.getElementById('pasted_rows');
    const previewSection = document.getElementById('previewSection');
    if (pastedTextarea) pastedTextarea.value = '';
    if (previewSection) previewSection.style.display = 'none';
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    filterLeads();
    initializeHOBAssignment();
    
    // Add better event listeners with debouncing
    let filterTimeout;
    function debouncedFilter() {
        clearTimeout(filterTimeout);
        filterTimeout = setTimeout(filterLeads, 150);
    }
    
    document.getElementById('statusFilter').addEventListener('input', debouncedFilter);
    document.getElementById('nameSearch').addEventListener('input', debouncedFilter);
    
    // Close add lead modal when clicking outside (dynamic check) - using capture phase and diagnostics
    document.addEventListener('click', function(e) {
        const modal = document.getElementById('addLeadModal');
        if (modal && e.target === modal) {
            console.log('[modal] overlay clicked', { target: e.target, modalId: modal.id });
            closeAddLeadModal();
        }
    }, true);

    // Handle modal close buttons via delegation (works after DOM replacements) - capture phase to beat other handlers
    document.addEventListener('click', function(e) {
        const closeBtn = e.target.closest('.modal-close');
        if (!closeBtn) return;
        const modal = closeBtn.closest('.modal');
        console.log('[modal] close button clicked', { target: e.target, closeBtn: closeBtn, modalId: modal ? modal.id : null });
        if (!modal) {
            // fallback: hide any known modals
            const fallback = document.getElementById('addLeadModal') || document.getElementById('importExcelModal');
            if (fallback) {
                fallback.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
            return;
        }
        if (modal.id === 'addLeadModal') {
            closeAddLeadModal();
        } else if (modal.id === 'importExcelModal') {
            closeImportModal();
        } else {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    }, true);

    // Close modal with escape key (dynamic checks) and diagnostics
    document.addEventListener('keydown', function(e) {
        if (e.key !== 'Escape') return;
        console.log('[modal] Escape pressed');
        const modal = document.getElementById('addLeadModal');
        if (modal && modal.style.display === 'flex') {
            console.log('[modal] closing addLeadModal via Escape');
            closeAddLeadModal();
        }
        const importModal = document.getElementById('importExcelModal');
        if (importModal && importModal.style.display === 'flex') {
            console.log('[modal] closing importExcelModal via Escape');
            closeImportModal();
        }
    }, true);

    // Import Excel modal click outside to close
    const importExcelModal = document.getElementById('importExcelModal');
    if (importExcelModal) {
        importExcelModal.addEventListener('click', function(e) {
            if (e.target === importExcelModal) {
                closeImportModal();
            }
        });
    }

    // Initialize import tabs
    initializeImportTabs();

    // Ensure modal close buttons are bound on initial load
    bindModalCloseHandlers();

    // --- ONE-TIME DEBUG: capture modal-close clicks to diagnose why the X button doesn't trigger handlers ---
    // This will run only until the first close-click is observed, then it removes itself.
    document.addEventListener('click', function oneTimeModalCloseCapture(e) {
        const btn = e.target.closest('.modal-close');
        if (!btn) return;
        console.log('[one-time-debug] capture close button clicked', {target: e.target, btn: btn});
        try {
            const rect = btn.getBoundingClientRect();
            const midX = rect.left + rect.width/2;
            const midY = rect.top + rect.height/2;
            const topEl = document.elementFromPoint(midX, midY);
            console.log('[one-time-debug] button rect and top element at center', {rect: rect, elementAtCenter: topEl});
        } catch (err) {
            console.log('[one-time-debug] elementFromPoint error', err);
        }
        // Attach a direct click listener to the button so future clicks also log
        btn.addEventListener('click', function directBtnListener(ev) {
            console.log('[one-time-debug] direct btn listener fired', {btn: btn, evTarget: ev.target});
            const rect2 = btn.getBoundingClientRect();
            const topEl2 = document.elementFromPoint(rect2.left + rect2.width/2, rect2.top + rect2.height/2);
            console.log('[one-time-debug] element at center after click', topEl2);
        }, {once: true});
        document.removeEventListener('click', oneTimeModalCloseCapture, true);
    }, true);

    // Add direct listeners to all modal-close buttons to ensure clicks are detected even if delegation fails
    document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', function(ev) {
            console.log('[debug] modal-close direct click', {btn: btn, target: ev.target});
        }, true);
    });
});
</script>

<style>
/* Search bar styles */
#nameSearch {
    transition: all 0.2s ease;
}

#nameSearch:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
}

#clearSearchBtn:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-primary);
}

/* Leads table layout improvements */
.table-scroll-vert {
    max-height: 65vh;
    overflow-y: auto;
    overflow-x: hidden;
    position: relative;
    width: 100%;
    padding-right: 8px; /* prevent scrollbar overlay */
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
}

.table-scroll-vert::-webkit-scrollbar {
    width: 6px;
}
.table-scroll-vert::-webkit-scrollbar-track {
    background: transparent;
}
.table-scroll-vert::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
}

/* Sticky header for better readability */
.bc-table thead th {
    position: sticky;
    top: 0;
    z-index: 1;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
}

/* Column sizing and text behavior */
.bc-table {
    table-layout: fixed;
    width: 100%;
    border-collapse: collapse;
}

/* Updated Column width definitions for 8 columns */
.bc-table th:first-child, 
.bc-table td:first-child { 
    width: 60px; 
    text-align: center; 
    font-weight: 600;
    color: var(--text-secondary);
}

.bc-table th:nth-child(2), 
.bc-table td:nth-child(2) { 
    width: 16%; 
}

.bc-table th:nth-child(3), 
.bc-table td:nth-child(3) { 
    width: 13%; 
}

.bc-table th:nth-child(4), 
.bc-table td:nth-child(4) { 
    width: 11%; 
}

.bc-table th:nth-child(5), 
.bc-table td:nth-child(5) { 
    width: 12%; 
}

.bc-table th:nth-child(6), 
.bc-table td:nth-child(6) { 
    width: 18%; 
}

.bc-table th:nth-child(7), 
.bc-table td:nth-child(7) { 
    width: 17%; 
}

.bc-table th:nth-child(8), 
.bc-table td:nth-child(8) { 
    width: 13%; 
    text-align: center;
}

.bc-table th,
.bc-table td {
    padding: 0.85rem 0.75rem;
    vertical-align: middle;
    border: none;
}

.bc-table td {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    background: transparent;
}

/* Ensure proper text alignment */
.bc-table th {
    text-align: left;
    font-weight: 600;
    color: var(--text-primary);
}

.bc-table th:first-child {
    text-align: center;
}

/* Badge refinements */
.bc-table td span[style*="background: rgba(59, 130, 246"] {
    display: inline-block;
    border: 1px solid rgba(59,130,246,0.35);
    min-width: 70px;
    text-align: center;
}

/* Row hover and striping */
.bc-table-striped tbody tr:nth-child(odd) {
    background: rgba(255,255,255,0.01);
}

.bc-table tbody tr:hover td {
    background: rgba(255,255,255,0.03) !important;
}

/* Ensure proper alignment for serial numbers */
.bc-table td:first-child {
    background: rgba(255, 255, 255, 0.02);
    border-right: 1px solid var(--border-color);
}

/* HOB Assignment Styles */
.hob-assignment {
    transition: all 0.2s ease;
}

.hob-assignment:focus {
    outline: 2px solid var(--accent);
    border-color: var(--accent);
}

.editable-select {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 0.35rem 1.5rem 0.35rem 0.7rem;
    font-size: 0.9rem;
    appearance: none;
    cursor: pointer;
    transition: all 0.18s;
    width: 100%;
    max-width: 180px;
}

.priority-high { color: #f87171; font-weight: 600; }
.priority-medium { color: #fbbf24; font-weight: 600; }
.priority-low { color: #60a5fa; font-weight: 600; }

/* Add Lead Modal Styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 10000;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
    /* Ensure overlay receives pointer events */
    pointer-events: auto;
}

/* Make the close button clearly clickable and on top */
.modal .modal-close {
    cursor: pointer;
    z-index: 10010;
    position: relative;
} 

.modal.show {
    display: flex;
}

.modal-content {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-large);
    display: flex;
    flex-direction: column;
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
}

.modal-content::-webkit-scrollbar {
    width: 6px;
}

.modal-content::-webkit-scrollbar-track {
    background: transparent;
}

.modal-content::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
}

.modal-title {
    color: var(--text-primary);
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
}

.modal-close {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 8px;
    transition: all 0.2s ease;
}

.modal-close:hover {
    color: var(--text-primary);
    background: rgba(255, 255, 255, 0.1);
}

.form-field {
    display: flex;
    flex-direction: column;
    margin-bottom: 1rem;
}

.form-field label {
    color: var(--text-primary);
    font-size: 0.9rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.form-input, .form-select, .form-textarea {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 0.75rem;
    font-size: 0.9rem;
    transition: border 0.2s ease;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
}

.form-textarea {
    resize: vertical;
    min-height: 80px;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding: 1.5rem;
    border-top: 1px solid var(--border-color);
    flex-shrink: 0;
}

.add-leads-btn {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    border-color: var(--border-color);
}

.add-leads-btn:hover {
    background: var(--border-hover);
    border-color: var(--border-hover);
}

.btn {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-notes {
    background: var(--bg-secondary);
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
}

.btn-notes:hover {
    background: var(--border-hover);
    color: var(--text-primary);
}

.btn-contact {
    background: var(--accent);
    color: var(--bg-primary);
    border: 1px solid var(--accent);
}

.btn-contact:hover {
    background: var(--accent-hover);
    border-color: var(--accent-hover);
}

.btn-contact:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Active tab styles for import modal */
.active-tab {
    background: var(--accent) !important;
    color: var(--bg-primary) !important;
}

.btn:not(.active-tab) {
    background: var(--bg-secondary);
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
}

.btn:not(.active-tab):hover {
    background: var(--border-hover);
    color: var(--text-primary);
}

/* Toast animations */
@keyframes slideIn {
    from { 
        transform: translateX(100%) scale(0.95); 
        opacity: 0; 
    }
    to { 
        transform: translateX(0) scale(1); 
        opacity: 1; 
    }
}

@keyframes slideOut {
    from { 
        transform: translateX(0) scale(1); 
        opacity: 1; 
    }
    to { 
        transform: translateX(100%) scale(0.95); 
        opacity: 0; 
    }
}

/* Responsive design */
@media (max-width: 1024px) {
    /* Hide some columns on medium screens */
    .bc-table th:nth-child(6), 
    .bc-table td:nth-child(6),
    .bc-table th:nth-child(8), 
    .bc-table td:nth-child(8) { 
        display: none; 
    }
    
    /* Redistribute widths for remaining columns */
    .bc-table th:nth-child(2), .bc-table td:nth-child(2) { width: 22%; }
    .bc-table th:nth-child(3), .bc-table td:nth-child(3) { width: 18%; }
    .bc-table th:nth-child(4), .bc-table td:nth-child(4) { width: 15%; }
    .bc-table th:nth-child(5), .bc-table td:nth-child(5) { width: 22%; }
    .bc-table th:nth-child(7), .bc-table td:nth-child(7) { width: 21%; }
}

@media (max-width: 768px) {
    /* Hide more columns on small screens */
    .bc-table th:nth-child(4), 
    .bc-table td:nth-child(4),
    .bc-table th:nth-child(6), 
    .bc-table td:nth-child(6) { 
        display: none; 
    }
    
    /* Further adjust remaining columns */
    .bc-table th:nth-child(2), .bc-table td:nth-child(2) { width: 28%; }
    .bc-table th:nth-child(3), .bc-table td:nth-child(3) { width: 24%; }
    .bc-table th:nth-child(5), .bc-table td:nth-child(5) { width: 25%; }
    .bc-table th:nth-child(7), .bc-table td:nth-child(7) { width: 21%; }
}
</style>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>