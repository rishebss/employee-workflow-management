<div class="table-container">
    <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <div style="display: flex; align-items: center; gap: 0.75rem;">
           
            <span id="visibleCount" style="font-size: 1.0rem;color: white;font-weight: 600;">&nbsp;</span>
        </div>
        
        <!-- Add Lead and Filters -->
        <div style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;">
            <!-- Search Bar -->
            <div style="position: relative;">
                <input type="text" id="nameSearch" oninput="filterLeads()" placeholder="Search by name..." 
                       style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem 2.5rem 0.5rem 2.5rem; font-size: 0.9rem; min-width: 200px;">
                <i class="fas fa-search" style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary); font-size: 0.9rem;"></i>
                <button type="button" onclick="clearSearch()" style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 0.25rem; border-radius: 4px; display: none;" id="clearSearchBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Source Filter -->
            <select id="sourceFilter" onchange="filterLeads()" style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem; font-size: 0.9rem;">
                <option value="">All Sources</option>
                {% for value, label in source_choices %}
                    <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
            </select>
            
            <!-- Status Filter -->
            <input type="text" id="statusFilter" oninput="filterLeads()" placeholder="Filter by status..." list="status-suggestions"
                   style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem; font-size: 0.9rem; min-width: 160px;">
            
            <!-- Staff Filter -->
            <select id="staffFilter" onchange="filterLeads()" style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem; font-size: 0.9rem;">
                <option value="">All Staff</option>
                <option value="Unassigned">Unassigned</option>
                {% for staff in staff_members %}
                    <option value="{{ staff.id }}">{{ staff.get_full_name }}</option>
                {% endfor %}
            </select>
            <button class="add-leads-btn" id="addLeadBtn" style="background: var(--accent); color: var(--bg-primary); border-color: var(--accent);">
                <i class="fas fa-plus"></i>
                <span>Add Lead</span>
            </button>
        </div>
    </div>
    
    <div class="table-scroll-vert">
        <table class="bc-table bc-table-striped" id="leadsTable">
            <thead>
                <tr>
                    <th style="width: 60px">#</th>
                    <th>Name</th>
                    <th>Phone</th>
                    <th>Source</th>
                    <th>Status</th>
                    <th>Program</th>
                    <th>Assigned To</th>
                    <th>Created</th>
                </tr>
            </thead>
            <tbody id="leadsTableBody">
                {% for lead in leads %}
                <tr class="lead-row" 
                    data-source="{{ lead.source }}"
                    data-status="{{ lead.status|lower }}"
                    data-staff="{{ lead.assigned_to.id|default:'' }}"
                    data-program="{{ lead.program|default:''|lower }}"
                    data-name="{{ lead.name|lower }}">
                    <td style="text-align: center; font-weight: 600; color: var(--text-secondary);">{{ forloop.counter }}</td>
                    <td>
                        <a href="{% url 'accounts:lead_details' lead.id %}" style="color: var(--accent); text-decoration: none; font-weight: 500;">
                            {{ lead.name }}
                        </a>
                    </td>
                    <td>{{ lead.phone }}</td>
                    <td>
                        <span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; background: rgba(59, 130, 246, 0.2); color: #93c5fd;">
                            {{ lead.source }}
                        </span>
                    </td>
                    
                    <!-- Status Column -->
                    <td>
                        <input type="text" class="status-input hob-assignment" 
                               data-lead-id="{{ lead.id }}" 
                               value="{{ lead.status|default:'' }}" 
                               placeholder="Enter status" 
                               list="status-suggestions"
                               style="width: 100%; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.35rem 0.7rem; font-size: 0.9rem;" />
                    </td>
                    
                    <!-- Program Column -->
                    <td>
                        <input type="text" class="program-input hob-assignment" 
                               data-lead-id="{{ lead.id }}" 
                               value="{{ lead.program|default:'' }}" 
                               placeholder="Enter program"
                               style="width: 100%; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.35rem 0.7rem; font-size: 0.9rem;" />
                    </td>
                    
                    <!-- Assignment Column -->
                    <td>
                        <select class="editable-select assign-select hob-assignment" 
                                data-lead-id="{{ lead.id }}"
                                data-field="assigned_to">
                            <option value="">Unassigned</option>
                            
                            <!-- Admission Managers Group -->
                            <optgroup label="Admission Managers">
                                {% for manager in admission_managers %}
                                <option value="{{ manager.id }}" 
                                        {% if lead.assigned_to == manager %}selected{% endif %}>
                                    {{ manager.get_full_name }} (Manager)
                                </option>
                                {% endfor %}
                            </optgroup>
                            
                            <!-- Admission Executives Group -->
                            <optgroup label="Admission Executives">
                                {% for executive in admission_executives %}
                                <option value="{{ executive.id }}" 
                                        {% if lead.assigned_to == executive %}selected{% endif %}>
                                    {{ executive.get_full_name }} (Executive)
                                </option>
                                {% endfor %}
                            </optgroup>
                        </select>
                    </td>
                    
                    <td>{{ lead.created_at|date:"M d, Y" }}</td>
                </tr>
                {% empty %}
                <tr id="noLeadsRow">
                    <td colspan="8" style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                        No leads found
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add Lead Modal -->
<div id="addLeadModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Add New Lead</h2>
            <button class="modal-close" type="button" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="addLeadForm" style="display: flex; flex-direction: column; flex: 1;">
            {% csrf_token %}
            <div style="padding: 1.5rem; flex: 1; overflow-y: auto; min-height: 0;">
                <div class="form-field">
                    <label for="leadName">Name *</label>
                    <input type="text" id="leadName" name="name" class="form-input" required placeholder="Enter lead name">
                    </div>
                
                <div class="form-field">
                    <label for="leadPhone">Phone *</label>
                    <input type="tel" id="leadPhone" name="phone" class="form-input" required placeholder="Enter phone number">
                </div>
                
                <div class="form-field">
                    <label for="leadEmail">Email</label>
                    <input type="email" id="leadEmail" name="email" class="form-input" placeholder="Enter email address">
                    </div>
                
                <div class="form-field">
                    <label for="leadLocation">Location</label>
                    <input type="text" id="leadLocation" name="location" class="form-input" placeholder="Enter location">
                </div>
                
                <div class="form-field">
                    <label for="leadProgram">Program</label>
                    <input type="text" id="leadProgram" name="program" class="form-input" placeholder="Enter program/course">
                        </div>
                
                <div class="form-field">
                    <label for="leadPriority">Priority</label>
                    <select id="leadPriority" name="priority" class="form-select">
                        <option value="MEDIUM">Medium</option>
                        <option value="HIGH">High</option>
                        <option value="LOW">Low</option>
                    </select>
                    </div>
                
                <div class="form-field">
                    <label for="leadStatus">Status</label>
                    <input type="text" id="leadStatus" name="status" class="form-input" placeholder="Enter status" list="status-suggestions" value="ENQUIRY">
                </div>
                
                <div class="form-field">
                    <label for="leadSource">Source</label>
                    <select id="leadSource" name="source" class="form-select">
                        {% for value, label in source_choices %}
                            <option value="{{ value }}" {% if value == 'WHATSAPP' %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-field">
                    <label for="leadRemarks">Remarks</label>
                    <textarea id="leadRemarks" name="remarks" class="form-textarea" placeholder="Enter any additional remarks"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-notes" data-modal-close>Cancel</button>
                <button type="submit" class="btn btn-contact" id="addLeadButton">
                    <i class="fas fa-plus mr-1"></i> Add Lead
                </button>
            </div>
        </form>
    </div>
</div>



<!-- Status suggestions shared with overview/status vocabulary -->
<datalist id="status-suggestions">
    <option value="ENQUIRY">
    <option value="INTERESTED">
    <option value="NOT_INTERESTED">
    <option value="WALK_IN">
    <option value="ON_HOLD">
    <option value="REGISTERED">
    <option value="FOLLOW_UP">
    <option value="CONVERTED">
    <option value="LOST">
    <option value="COLD">
    <option value="WARM">
    <option value="HOT">
    <option value="Enquiry">
    <option value="Interested">
    <option value="Not Interested">
    <option value="Walk In">
    <option value="On Hold">
    <option value="Registered">
    <option value="Follow Up">
    <option value="Converted">
    <option value="Lost">
    <option value="Cold">
    <option value="Warm">
    <option value="Hot">
</datalist>

<!-- Add the rest of your HTML exactly as before, but replace the script section with this: -->

<script>
// CSRF helper for axios
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

// Configure axios
axios.defaults.headers.common['X-CSRFToken'] = getCookie('csrftoken');
axios.defaults.xsrfCookieName = 'csrftoken';
axios.defaults.xsrfHeaderName = 'X-CSRFToken';

// SIMPLE AND RELIABLE ADD LEAD BUTTON HANDLER - Use event delegation at document level
document.addEventListener('click', function(e) {
    // Handle add lead button click
    const addBtn = e.target.closest('#addLeadBtn');
    if (addBtn) {
        console.log('Add lead button clicked (document delegation)');
        const modal = document.getElementById('addLeadModal');
        if (modal) {
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            resetAddLeadForm();
        }
        return;
    }
    
    // Handle modal close buttons
    const closeBtn = e.target.closest('.modal-close') || e.target.closest('[data-modal-close]');
    if (closeBtn) {
        e.preventDefault();
        e.stopPropagation();
        const modal = closeBtn.closest('.modal');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            resetAddLeadForm();
        }
        return;
    }
});

// Close modal when clicking outside
document.addEventListener('click', function(e) {
    const modal = document.getElementById('addLeadModal');
    if (modal && e.target === modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
        resetAddLeadForm();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = document.getElementById('addLeadModal');
        if (modal && modal.style.display === 'flex') {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            resetAddLeadForm();
        }
    }
});

function resetAddLeadForm() {
    const form = document.getElementById('addLeadForm');
    if (form) {
        form.reset();
        // Set default values
        const statusField = document.getElementById('leadStatus');
        const priorityField = document.getElementById('leadPriority');
        if (statusField) statusField.value = 'ENQUIRY';
        if (priorityField) priorityField.value = 'MEDIUM';
        
        // Reset button state
        const addButton = document.getElementById('addLeadButton');
        if (addButton) {
            addButton.disabled = false;
            addButton.innerHTML = '<i class="fas fa-plus mr-1"></i> Add Lead';
        }
    }
}

// IMPROVED FILTER FUNCTION WITH BETTER UNASSIGNED HANDLING
function filterLeads() {
    const sourceFilter = document.getElementById('sourceFilter')?.value || '';
    const statusFilter = document.getElementById('statusFilter')?.value.toLowerCase() || '';
    const staffFilter = document.getElementById('staffFilter')?.value || '';
    const nameSearch = document.getElementById('nameSearch')?.value.toLowerCase() || '';

    const tableBody = document.getElementById('leadsTableBody');
    if (!tableBody) return;
    
    const rows = tableBody.querySelectorAll('.lead-row');
    const noLeadsRow = document.getElementById('noLeadsRow');
    let visibleCount = 0;

    // Show/hide clear search button
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    if (clearSearchBtn) {
        clearSearchBtn.style.display = nameSearch ? 'block' : 'none';
    }

    // First, hide the "no leads" row if it exists
    if (noLeadsRow) {
        noLeadsRow.style.display = 'none';
    }

    // Filter each row and update serial numbers
    rows.forEach((row, index) => {
        const source = row.dataset.source || '';
        const status = row.dataset.status || '';
        const staff = row.dataset.staff || '';
        const program = row.dataset.program || '';
        const name = row.dataset.name || '';

        const sourceMatch = !sourceFilter || source === sourceFilter;
        const statusMatch = !statusFilter || status.includes(statusFilter);
        
        // IMPROVED: Handle staff filter including 'Unassigned' option
        let staffMatch = true;
        if (staffFilter) {
            if (staffFilter === 'Unassigned') {
                // More robust check for unassigned leads
                staffMatch = !staff || staff.trim() === '' || staff === 'undefined' || staff === 'null';
            } else {
                staffMatch = staff === staffFilter;
            }
        }
        
        const nameMatch = !nameSearch || name.includes(nameSearch);

        if (sourceMatch && statusMatch && staffMatch && nameMatch) {
            row.style.display = '';
            // Update the serial number for visible rows
            const serialCell = row.querySelector('td:first-child');
            if (serialCell) {
                serialCell.textContent = visibleCount + 1;
            }
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    // Update visible count and handle empty states
    updateVisibleCount(visibleCount, rows.length);
    handleEmptyStates(visibleCount, rows.length, tableBody);
}

// Helper function to update visible count display
function updateVisibleCount(visibleCount, totalCount) {
    const countEl = document.getElementById('visibleCount');
    if (countEl) {
        if (visibleCount === totalCount) {
            countEl.textContent = `(${totalCount} leads)`;
        } else {
            countEl.textContent = `(Showing ${visibleCount} of ${totalCount})`;
        }
    }
}

// Helper function to handle empty states
function handleEmptyStates(visibleCount, totalCount, tableBody) {
    // Remove existing no-results message
    const existingNoResults = tableBody.querySelector('.no-results-message');
    if (existingNoResults) {
        existingNoResults.remove();
    }

    if (visibleCount === 0) {
        let message = '';
        
        if (totalCount === 0) {
            // No leads in the system
            const noLeadsRow = document.getElementById('noLeadsRow');
            if (noLeadsRow) {
                noLeadsRow.style.display = '';
            }
        } else {
            // Leads exist but none match filters
            message = 'No leads match the selected filters';
            
            // Check which filters are active to provide more specific message
            const sourceFilter = document.getElementById('sourceFilter')?.value || '';
            const statusFilter = document.getElementById('statusFilter')?.value || '';
            const staffFilter = document.getElementById('staffFilter')?.value || '';
            const nameSearch = document.getElementById('nameSearch')?.value || '';
            
            if (staffFilter === 'Unassigned') {
                message = 'No unassigned leads found';
            } else if (sourceFilter) {
                message = `No leads found for source: ${sourceFilter}`;
            } else if (statusFilter) {
                message = `No leads found with status: ${statusFilter}`;
            } else if (nameSearch) {
                message = `No leads found matching: "${nameSearch}"`;
            }
            
            const noResultsRow = document.createElement('tr');
            noResultsRow.className = 'no-results-message';
            noResultsRow.innerHTML = `<td colspan="8" style="text-align: center; color: var(--text-secondary); padding: 2rem;">${message}</td>`;
            tableBody.appendChild(noResultsRow);
        }
    }
}

function clearSearch() {
    const nameSearch = document.getElementById('nameSearch');
    if (nameSearch) {
        nameSearch.value = '';
        filterLeads();
    }
}

function resetLeadFilters() {
    const sourceFilter = document.getElementById('sourceFilter');
    const statusFilter = document.getElementById('statusFilter');
    const staffFilter = document.getElementById('staffFilter');
    const nameSearch = document.getElementById('nameSearch');
    
    if (sourceFilter) sourceFilter.value = '';
    if (statusFilter) statusFilter.value = '';
    if (staffFilter) staffFilter.value = '';
    if (nameSearch) nameSearch.value = '';
    
    filterLeads();
}

// SIMPLE FORM SUBMISSION HANDLER
document.addEventListener('submit', function(e) {
    if (e.target.id === 'addLeadForm') {
        e.preventDefault();
        handleAddLead();
    }
});

// Handle add lead
async function handleAddLead() {
    const form = document.getElementById('addLeadForm');
    const addButton = document.getElementById('addLeadButton');
    
    if (!form || !addButton) {
        showToast('Form error - please refresh the page', 'error');
        return;
    }
    
    // Get form data
    const formData = new FormData(form);
    const leadData = {
        name: formData.get('name'),
        phone: formData.get('phone'),
        email: formData.get('email') || '',
        location: formData.get('location') || '',
        program: formData.get('program') || '',
        priority: formData.get('priority'),
        status: formData.get('status'),
        source: formData.get('source'),
        remarks: formData.get('remarks') || ''
    };
    
    // Validate required fields
    if (!leadData.name || !leadData.phone) {
        showToast('Name and phone are required', 'error');
        return;
    }
    
    if (leadData.phone.length < 10) {
        showToast('Phone number must be at least 10 digits', 'error');
        return;
    }
    
    addButton.disabled = true;
    addButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Adding...';
    
    try {
        const csrfToken = getCookie('csrftoken');

        const response = await fetch("{% url 'accounts:add_lead' %}", {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(leadData)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showToast('Lead added successfully!', 'success');
            setTimeout(() => {
                // Close modal
                const modal = document.getElementById('addLeadModal');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
                resetAddLeadForm();
                
                // Reload only the Leads tab if tab loader is available
                if (typeof window.loadTabContent === 'function') {
                    window.loadTabContent('leads');
                } else {
                    window.location.reload();
                }
            }, 1500);
        } else {
            showToast(`Failed to add lead: ${data.message}`, 'error');
            addButton.disabled = false;
            addButton.innerHTML = '<i class="fas fa-plus mr-1"></i> Add Lead';
        }
    } catch (error) {
        console.error('Add lead error:', error);
        showToast(`Error adding lead: ${error.message}`, 'error');
        addButton.disabled = false;
        addButton.innerHTML = '<i class="fas fa-plus mr-1"></i> Add Lead';
    }
}

// Simple toast notification function
function showToast(message, type) {
    // Remove any existing toasts
    document.querySelectorAll('.toast-notification').forEach(toast => toast.remove());
    
    const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    
    if (type === 'success') {
        toast.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.9) 0%, rgba(16, 185, 129, 0.8) 100%)';
    } else if (type === 'error') {
        toast.style.background = 'linear-gradient(135deg, rgba(239, 68, 68, 0.9) 0%, rgba(239, 68, 68, 0.8) 100%)';
    }
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// GM Assignment functionality (similar to HOB implementation)
function initializeGMAssignment() {
    // Handle select updates (assignments, priority)
    document.querySelectorAll('.hob-assignment').forEach(element => {
        if (element.tagName === 'SELECT') {
            element.dataset.previousValue = element.value;
            element.addEventListener('change', function() {
                console.debug('[GM] select changed', {
                    leadId: this.dataset.leadId,
                    field: this.dataset.field,
                    value: this.value
                });
                handleGMFieldUpdate(this);
            });
        }
    });

    // Handle free-text status input updates
    document.querySelectorAll('.status-input.hob-assignment').forEach(input => {
        input.dataset.originalValue = input.value;
        const commitChange = () => {
            const leadId = input.dataset.leadId;
            const newStatus = (input.value || '').trim();
            if (!newStatus) {
                showToast('Status cannot be empty', 'error');
                input.value = input.dataset.originalValue;
                return;
            }
            updateGMLeadField(leadId, 'status', newStatus)
                .then(() => {
                    input.dataset.originalValue = newStatus;
                    const row = input.closest('tr');
                    if (row) row.dataset.status = newStatus.toLowerCase();
                    showToast('Status updated successfully', 'success');
                })
                .catch(() => {
                    input.value = input.dataset.originalValue;
                    showToast('Failed to update status', 'error');
                });
        };
        input.addEventListener('blur', commitChange);
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                commitChange();
                input.blur();
            }
            if (e.key === 'Escape') {
                input.value = input.dataset.originalValue;
                input.blur();
            }
        });
    });

    // Handle program input updates
    document.querySelectorAll('.program-input.hob-assignment').forEach(input => {
        input.dataset.originalValue = input.value;
        input.addEventListener('change', function() {
            const leadId = this.dataset.leadId;
            const newProgram = this.value;
            updateGMLeadField(leadId, 'program', newProgram)
                .then(() => {
                    this.dataset.originalValue = newProgram;
                    const row = this.closest('tr');
                    if (row) row.dataset.program = newProgram.toLowerCase();
                    showToast('Program updated successfully', 'success');
                })
                .catch(() => {
                    this.value = this.dataset.originalValue;
                    showToast('Failed to update program', 'error');
                });
        });
    });
}

function handleGMFieldUpdate(selectElement) {
    const leadId = selectElement.dataset.leadId;
    const field = selectElement.dataset.field;
    const value = selectElement.value;
    console.debug('[GM] handleGMFieldUpdate', { leadId, field, value });

    updateGMLeadField(leadId, field, value)
        .then((response) => {
            console.debug('[GM] updateGMLeadField success', response);
            const row = selectElement.closest('tr');
            updateGMRowSearchData(row, field, value);
            selectElement.dataset.previousValue = value;
            let fieldName = field.replace('_', ' ');
            fieldName = fieldName.charAt(0).toUpperCase() + fieldName.slice(1);
            showToast(`${fieldName} updated successfully`, 'success');
        })
        .catch((error) => {
            console.error(`[GM] Error updating ${field}:`, error?.response?.data || error);
            if (error.response && error.response.data && error.response.data.message) {
                showToast(error.response.data.message, 'error');
            } else {
                showToast(`Failed to update ${field}`, 'error');
            }
            selectElement.value = selectElement.dataset.previousValue;
        });
}

function updateGMLeadField(leadId, field, value) {
    return new Promise((resolve, reject) => {
        console.debug('[GM] POST -> gm_assign_lead', { leadId, field, value });
        axios.post('{% url "gm:gm_assign_lead" %}', JSON.stringify({
            lead_id: leadId,
            field: field,
            value: value
        }), {
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            console.debug('[GM] assign response', response?.data);
            resolve(response.data);
        })
        .catch(error => {
            console.error('[GM] assign error', error?.response?.data || error);
            reject(error);
        });
    });
}

function updateGMRowSearchData(row, field, value) {
    if (!row) return;
    if (field === 'assigned_to') {
        row.dataset.staff = value === '' ? '' : value;
    } else if (field === 'priority') {
        row.dataset.priority = value.toLowerCase();
    }
    filterLeads();
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    filterLeads();
    initializeGMAssignment();
    
    // Add better event listeners with debouncing
    let filterTimeout;
    function debouncedFilter() {
        clearTimeout(filterTimeout);
        filterTimeout = setTimeout(filterLeads, 150);
    }
    
    const statusFilter = document.getElementById('statusFilter');
    const nameSearch = document.getElementById('nameSearch');
    
    if (statusFilter) {
        statusFilter.addEventListener('input', debouncedFilter);
    }
    if (nameSearch) {
        nameSearch.addEventListener('input', debouncedFilter);
    }
    
    // Also bind the form submit event directly (as backup)
    const addLeadForm = document.getElementById('addLeadForm');
    if (addLeadForm) {
        addLeadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            handleAddLead();
        });
    }
});
</script>

<style>
/* Search bar styles */
#nameSearch {
    transition: all 0.2s ease;
}

#nameSearch:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
}

#clearSearchBtn:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-primary);
}

/* Leads table layout improvements */
.table-scroll-vert {
    max-height: 65vh;
    overflow-y: auto;
    overflow-x: hidden;
    position: relative;
    width: 100%;
    padding-right: 8px; /* prevent scrollbar overlay */
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
}

.table-scroll-vert::-webkit-scrollbar {
    width: 6px;
}
.table-scroll-vert::-webkit-scrollbar-track {
    background: transparent;
}
.table-scroll-vert::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
}

/* Sticky header for better readability */
.bc-table thead th {
    position: sticky;
    top: 0;
    z-index: 1;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
}

/* Column sizing and text behavior */
.bc-table {
    table-layout: fixed;
    width: 100%;
    border-collapse: collapse;
}

/* Updated Column width definitions for 8 columns */
.bc-table th:first-child, 
.bc-table td:first-child { 
    width: 60px; 
    text-align: center; 
    font-weight: 600;
    color: var(--text-secondary);
}

.bc-table th:nth-child(2), 
.bc-table td:nth-child(2) { 
    width: 16%; 
}

.bc-table th:nth-child(3), 
.bc-table td:nth-child(3) { 
    width: 13%; 
}

.bc-table th:nth-child(4), 
.bc-table td:nth-child(4) { 
    width: 11%; 
}

.bc-table th:nth-child(5), 
.bc-table td:nth-child(5) { 
    width: 12%; 
}

.bc-table th:nth-child(6), 
.bc-table td:nth-child(6) { 
    width: 18%; 
}

.bc-table th:nth-child(7), 
.bc-table td:nth-child(7) { 
    width: 17%; 
}

.bc-table th:nth-child(8), 
.bc-table td:nth-child(8) { 
    width: 13%; 
    text-align: center;
}

.bc-table th,
.bc-table td {
    padding: 0.85rem 0.75rem;
    vertical-align: middle;
    border: none;
}

.bc-table td {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    background: transparent;
}

/* Ensure proper text alignment */
.bc-table th {
    text-align: left;
    font-weight: 600;
    color: var(--text-primary);
}

.bc-table th:first-child {
    text-align: center;
}

/* Badge refinements */
.bc-table td span[style*="background: rgba(59, 130, 246"] {
    display: inline-block;
    border: 1px solid rgba(59,130,246,0.35);
    min-width: 70px;
    text-align: center;
}

/* Row hover and striping */
.bc-table-striped tbody tr:nth-child(odd) {
    background: rgba(255,255,255,0.01);
}

.bc-table tbody tr:hover td {
    background: rgba(255,255,255,0.03) !important;
}

/* Ensure proper alignment for serial numbers */
.bc-table td:first-child {
    background: rgba(255, 255, 255, 0.02);
    border-right: 1px solid var(--border-color);
}

/* HOB Assignment Styles */
.hob-assignment {
    transition: all 0.2s ease;
}

.hob-assignment:focus {
    outline: 2px solid var(--accent);
    border-color: var(--accent);
}

.editable-select {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 0.35rem 1.5rem 0.35rem 0.7rem;
    font-size: 0.9rem;
    appearance: none;
    cursor: pointer;
    transition: all 0.18s;
    width: 100%;
    max-width: 180px;
}

.priority-high { color: #f87171; font-weight: 600; }
.priority-medium { color: #fbbf24; font-weight: 600; }
.priority-low { color: #60a5fa; font-weight: 600; }

/* Add Lead Modal Styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 10000;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
}

.modal.show {
    display: flex;
}

.modal-content {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-large);
    display: flex;
    flex-direction: column;
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
}

.modal-content::-webkit-scrollbar {
    width: 6px;
}

.modal-content::-webkit-scrollbar-track {
    background: transparent;
}

.modal-content::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
}

.modal-title {
    color: var(--text-primary);
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
}

.modal-close {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 8px;
    transition: all 0.2s ease;
}

.modal-close:hover {
    color: var(--text-primary);
    background: rgba(255, 255, 255, 0.1);
}

.form-field {
    display: flex;
    flex-direction: column;
    margin-bottom: 1rem;
}

.form-field label {
    color: var(--text-primary);
    font-size: 0.9rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.form-input, .form-select, .form-textarea {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 0.75rem;
    font-size: 0.9rem;
    transition: border 0.2s ease;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
}

.form-textarea {
    resize: vertical;
    min-height: 80px;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding: 1.5rem;
    border-top: 1px solid var(--border-color);
    flex-shrink: 0;
}

.add-leads-btn {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    border-color: var(--border-color);
}

.add-leads-btn:hover {
    background: var(--border-hover);
    border-color: var(--border-hover);
}

.btn {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-notes {
    background: var(--bg-secondary);
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
}

.btn-notes:hover {
    background: var(--border-hover);
    color: var(--text-primary);
}

.btn-contact {
    background: var(--accent);
    color: var(--bg-primary);
    border: 1px solid var(--accent);
}

.btn-contact:hover {
    background: var(--accent-hover);
    border-color: var(--accent-hover);
}

.btn-contact:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Active tab styles for import modal */
.active-tab {
    background: var(--accent) !important;
    color: var(--bg-primary) !important;
}

.btn:not(.active-tab) {
    background: var(--bg-secondary);
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
}

.btn:not(.active-tab):hover {
    background: var(--border-hover);
    color: var(--text-primary);
}

/* Toast animations */
@keyframes slideIn {
    from { 
        transform: translateX(100%) scale(0.95); 
        opacity: 0; 
    }
    to { 
        transform: translateX(0) scale(1); 
        opacity: 1; 
    }
}

@keyframes slideOut {
    from { 
        transform: translateX(0) scale(1); 
        opacity: 1; 
    }
    to { 
        transform: translateX(100%) scale(0.95); 
        opacity: 0; 
    }
}

/* Responsive design */
@media (max-width: 1024px) {
    /* Hide some columns on medium screens */
    .bc-table th:nth-child(6), 
    .bc-table td:nth-child(6),
    .bc-table th:nth-child(8), 
    .bc-table td:nth-child(8) { 
        display: none; 
    }
    
    /* Redistribute widths for remaining columns */
    .bc-table th:nth-child(2), .bc-table td:nth-child(2) { width: 22%; }
    .bc-table th:nth-child(3), .bc-table td:nth-child(3) { width: 18%; }
    .bc-table th:nth-child(4), .bc-table td:nth-child(4) { width: 15%; }
    .bc-table th:nth-child(5), .bc-table td:nth-child(5) { width: 22%; }
    .bc-table th:nth-child(7), .bc-table td:nth-child(7) { width: 21%; }
}

@media (max-width: 768px) {
    /* Hide more columns on small screens */
    .bc-table th:nth-child(4), 
    .bc-table td:nth-child(4),
    .bc-table th:nth-child(6), 
    .bc-table td:nth-child(6) { 
        display: none; 
    }
    
    /* Further adjust remaining columns */
    .bc-table th:nth-child(2), .bc-table td:nth-child(2) { width: 28%; }
    .bc-table th:nth-child(3), .bc-table td:nth-child(3) { width: 24%; }
    .bc-table th:nth-child(5), .bc-table td:nth-child(5) { width: 25%; }
    .bc-table th:nth-child(7), .bc-table td:nth-child(7) { width: 21%; }
}
</style>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>